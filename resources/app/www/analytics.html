<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Danfosal App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'] },
                    colors: {
                        background: '#050b07',
                        surface: { dark: '#0a120c', light: '#121e16' },
                        primary: '#4ade80',
                        secondary: '#a855f7',
                        accent: '#f43f5e'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050b07; color: #e5e7eb; }
        .glass-panel {
            background: rgba(10, 18, 12, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .glass-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #050b07; }
        ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #374151; }
        
        /* Map Customization */
        .leaflet-container { background: #050b07; font-family: 'Manrope'; }
        .leaflet-popup-content-wrapper { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); border-radius: 8px; }
        .leaflet-popup-tip { background: rgba(255, 255, 255, 0.9); }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-primary/20 selection:text-primary">

    <!-- Sidebar -->
    <aside class="w-20 lg:w-64 border-r border-white/5 flex flex-col bg-surface-dark/50 backdrop-blur-xl z-50 transition-all duration-300">
        <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-white/5">
            <div class="size-8 rounded-lg bg-gradient-to-br from-primary to-emerald-600 flex items-center justify-center shadow-[0_0_15px_rgba(74,222,128,0.3)]">
                <span class="material-symbols-outlined text-black text-xl font-bold">analytics</span>
            </div>
            <span class="ml-3 font-bold text-lg hidden lg:block tracking-tight">Danfosal<span class="text-primary">.AI</span></span>
        </div>

        <nav class="flex-1 py-6 px-3 space-y-1 overflow-y-auto">
            <a href="index.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-white/60 hover:text-white hover:bg-white/5 transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">dashboard</span>
                <span class="hidden lg:block font-medium">Dashboard</span>
            </a>
            <a href="#" class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-primary/10 text-primary border border-primary/10 transition-all">
                <span class="material-symbols-outlined">monitoring</span>
                <span class="hidden lg:block font-medium">Analytics</span>
            </a>
            <a href="online-orders.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-white/60 hover:text-white hover:bg-white/5 transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">orders</span>
                <span class="hidden lg:block font-medium">Orders</span>
            </a>
            <a href="products.html" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-white/60 hover:text-white hover:bg-white/5 transition-all group">
                <span class="material-symbols-outlined group-hover:scale-110 transition-transform">inventory_2</span>
                <span class="hidden lg:block font-medium">Products</span>
            </a>
            
            <div class="my-4 border-t border-white/5"></div>
            
            <div class="px-3 mb-2 hidden lg:block text-xs font-bold text-white/30 uppercase tracking-wider">Filters</div>
            <div class="px-3">
                <select id="sidebar-time-filter" class="w-full bg-surface-light border border-white/10 rounded-lg px-3 py-2 text-sm text-white/80 focus:outline-none focus:border-primary/50 transition-colors">
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 3 Months</option>
                    <option value="all">All Time</option>
                </select>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-background">
        <!-- Header -->
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-surface-dark/30 backdrop-blur-md z-40">
            <h1 class="text-xl font-bold text-white/90">Performance Overview</h1>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 bg-surface-light border border-white/10 rounded-lg p-1">
                    <button onclick="scrollToSection('kpi-grid')" class="px-3 py-1.5 rounded-md text-xs font-medium bg-white/10 text-white shadow-sm hover:bg-white/20 transition-colors">Overview</button>
                    <button onclick="scrollToSection('sales-charts')" class="px-3 py-1.5 rounded-md text-xs font-medium text-white/50 hover:text-white hover:bg-white/5 transition-colors">Sales</button>
                    <button onclick="scrollToSection('customer-lists')" class="px-3 py-1.5 rounded-md text-xs font-medium text-white/50 hover:text-white hover:bg-white/5 transition-colors">Customers</button>
                </div>
                <div class="h-8 w-px bg-white/10 mx-2"></div>
                <div class="flex items-center gap-3">
                    <select id="main-time-filter" class="bg-surface-light border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white/80 focus:outline-none focus:border-primary/50">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="all">All Time</option>
                    </select>
                    <button onclick="updateAnalytics()" class="bg-primary hover:bg-primary/90 text-black text-sm font-bold px-4 py-1.5 rounded-lg shadow-[0_0_15px_rgba(74,222,128,0.3)] transition-all active:scale-95">
                        Refresh Data
                    </button>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            
            <!-- KPI Grid -->
            <div id="kpi-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Revenue -->
                <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <span class="material-symbols-outlined text-6xl text-primary">payments</span>
                    </div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="p-2 rounded-lg bg-primary/10 text-primary">
                            <span class="material-symbols-outlined text-xl">attach_money</span>
                        </div>
                        <span class="text-sm font-medium text-white/50">Total Revenue</span>
                    </div>
                    <div class="text-3xl font-bold text-white tracking-tight" id="kpi-revenue">‚Ç¨0.00</div>
                    <div class="mt-2 flex items-center gap-2 text-xs">
                        <span class="text-emerald-400 flex items-center font-medium"><span class="material-symbols-outlined text-sm mr-0.5">trending_up</span> +12.5%</span>
                        <span class="text-white/30">vs last period</span>
                    </div>
                </div>

                <!-- Profit -->
                <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <span class="material-symbols-outlined text-6xl text-emerald-500">savings</span>
                    </div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-500">
                            <span class="material-symbols-outlined text-xl">trending_up</span>
                        </div>
                        <span class="text-sm font-medium text-white/50">Net Profit</span>
                    </div>
                    <div class="text-3xl font-bold text-white tracking-tight" id="kpi-profit">‚Ç¨0.00</div>
                    <div class="mt-2 flex items-center gap-2 text-xs">
                        <span class="text-emerald-400 flex items-center font-medium">Healthy Margin</span>
                    </div>
                </div>

                <!-- Avg Order -->
                <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <span class="material-symbols-outlined text-6xl text-purple-500">shopping_bag</span>
                    </div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="p-2 rounded-lg bg-purple-500/10 text-purple-500">
                            <span class="material-symbols-outlined text-xl">shopping_basket</span>
                        </div>
                        <span class="text-sm font-medium text-white/50">Avg. Order Value</span>
                    </div>
                    <div class="text-3xl font-bold text-white tracking-tight" id="kpi-avg-order">‚Ç¨0.00</div>
                    <div class="mt-2 flex items-center gap-2 text-xs">
                        <span class="text-white/30">Per transaction</span>
                    </div>
                </div>

                <!-- Total Orders -->
                <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <span class="material-symbols-outlined text-6xl text-blue-500">group_add</span>
                    </div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="p-2 rounded-lg bg-blue-500/10 text-blue-500">
                            <span class="material-symbols-outlined text-xl">person_add</span>
                        </div>
                        <span class="text-sm font-medium text-white/50">Total Orders</span>
                    </div>
                    <div class="text-3xl font-bold text-white tracking-tight" id="kpi-acquisition">0</div>
                    <div class="mt-2 flex items-center gap-2 text-xs">
                        <span class="text-white/30">Total processed</span>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div id="sales-charts" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Revenue Chart -->
                <div class="lg:col-span-2 glass-panel p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-white">Revenue Analytics</h3>
                            <p class="text-xs text-white/40">Monthly performance trend</p>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/5">
                            <span class="size-2 rounded-full bg-primary animate-pulse"></span>
                            <span class="text-xs font-medium text-primary">Live Updates</span>
                        </div>
                    </div>
                    <div class="h-[300px] w-full">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Order Status Chart -->
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-1">Order Status</h3>
                    <p class="text-xs text-white/40 mb-6">Breakdown by status</p>
                    <div class="h-[250px] relative">
                        <canvas id="acquisitionChart"></canvas>
                        <!-- Center Text Overlay -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center">
                                <span class="block text-2xl font-bold text-white" id="chart-total-orders">0</span>
                                <span class="text-[10px] text-white/40 uppercase tracking-wider">Orders</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geo Map -->
            <div class="glass-panel p-0 rounded-2xl overflow-hidden border border-white/10 h-[400px] relative">
                <div class="absolute top-4 left-4 z-[400] bg-surface-dark/80 backdrop-blur px-4 py-2 rounded-lg border border-white/10 shadow-lg">
                    <h3 class="text-sm font-bold text-white">Global Reach</h3>
                    <p class="text-[10px] text-white/50">Customer locations heatmap</p>
                </div>
                <div id="map" class="h-full w-full bg-[#050b07]"></div>
            </div>

            <!-- Lists Row 1: Products, Locations, Customers, Debtors -->
            <div id="customer-lists" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Top Products -->
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">inventory_2</span> Top Products
                    </h3>
                    <div class="space-y-4" id="top-products-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Top Locations -->
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-purple-400">location_on</span> Top Locations
                    </h3>
                    <div class="space-y-4" id="top-locations-list">
                        <p class="text-white/40 text-sm">Loading...</p>
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-400">group</span> Top Customers
                    </h3>
                    <div class="space-y-4" id="top-customers-list">
                        <p class="text-white/40 text-sm">Loading...</p>
                    </div>
                </div>

                <!-- Top Debtors -->
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-red-400">money_off</span> Top Debtors
                    </h3>
                    <div class="space-y-4" id="top-debtors-list">
                        <p class="text-white/40 text-sm">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Lists Row 2: Creditors & Transactions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Top Creditors -->
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-yellow-400">account_balance_wallet</span> Top Creditors
                    </h3>
                    <div class="space-y-4" id="top-creditors-list">
                        <p class="text-white/40 text-sm">Loading...</p>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="md:col-span-2 glass-panel p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">Recent Transactions</h3>
                        <button class="text-xs text-primary hover:text-primary/80 font-medium">View All</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-white/5 text-xs text-white/40 uppercase tracking-wider">
                                    <th class="px-6 py-3 font-medium">Customer</th>
                                    <th class="px-6 py-3 font-medium">Source</th>
                                    <th class="px-6 py-3 font-medium text-right">Amount</th>
                                    <th class="px-6 py-3 font-medium text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5 text-sm" id="transactions-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, getDocs, query, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDUtblUqNiSCmC4kRjikE7D2kba0Mhxej4",
            authDomain: "danfosal-app.firebaseapp.com",
            projectId: "danfosal-app",
            storageBucket: "danfosal-app.appspot.com",
            messagingSenderId: "565855692028",
            appId: "1:565855692028:web:c7cb647497cb3df9452379",
            measurementId: "G-50JPG2KKEC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Enable Offline Persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                console.warn('Persistence failed: Browser not supported');
            }
        });

        const auth = getAuth(app);

        let map, markerCluster, heatLayer;
        let allOrdersData = [];
        let onlineOrdersData = [];
        let storeSalesData = [];
        let currentDaysFilter = '30'; // Default to 30 days
        let charts = {};

        // --- Helper Functions ---
        const getDate = (ts) => {
            if (!ts) return new Date();
            if (ts.toDate) return ts.toDate(); // Firestore Timestamp
            return new Date(ts); // String or Number
        };

        const mergeData = () => {
            console.log('üîÑ mergeData() called');
            console.log(`   - Online orders: ${onlineOrdersData.length}`);
            console.log(`   - Store sales: ${storeSalesData.length}`);
            
            const normalizedOnline = onlineOrdersData.map(o => ({
                ...o,
                source: 'Online',
                price: parseFloat(o.price) || 0,
                timestamp: o.timestamp
            }));

            const normalizedStore = storeSalesData.map(s => ({
                ...s,
                source: 'Store',
                price: parseFloat(s.total || s.price) || 0,
                status: 'Paid', // Store sales are typically paid immediately
                clientName: s.clientName || s.customerName || 'Walk-in Customer',
                address: s.address || s.customerAddress || null,
                timestamp: s.timestamp || s.scannedAt || (s.date ? new Date(s.date + (s.time ? ' ' + s.time : '')).getTime() : Date.now())
            }));

            allOrdersData = [...normalizedOnline, ...normalizedStore];
            // Sort by date desc
            allOrdersData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            console.log(`‚úÖ Merged total: ${allOrdersData.length} orders`);
            
            // Address field statistics
            const withAddress = allOrdersData.filter(o => o.address && o.address.trim()).length;
            const withCity = allOrdersData.filter(o => o.city && o.city.trim()).length;
            const withEither = allOrdersData.filter(o => (o.address && o.address.trim()) || (o.city && o.city.trim())).length;
            const withNeither = allOrdersData.length - withEither;
            
            console.log(`üìç ADDRESS STATISTICS:`);
            console.log(`   - Orders with 'address' field: ${withAddress} (${(withAddress/allOrdersData.length*100).toFixed(1)}%)`);
            console.log(`   - Orders with 'city' field: ${withCity} (${(withCity/allOrdersData.length*100).toFixed(1)}%)`);
            console.log(`   - Orders with either: ${withEither} (${(withEither/allOrdersData.length*100).toFixed(1)}%)`);
            console.log(`   - Orders with neither: ${withNeither} (${(withNeither/allOrdersData.length*100).toFixed(1)}%)`);
            
            updateAnalytics();
            updateMap();
        };

        // Load cache from localStorage
        const addressCache = JSON.parse(localStorage.getItem('danfosal_address_cache') || '{}');
        const processedOrderIds = new Set();

        // EXPANDED: Albanian city coordinates database (61 cities for ~90% instant coverage)
        const CITY_COORDINATES = {
            // Major cities (existing)
            'tirana': { lat: 41.3275, lng: 19.8187 },
            'tirane': { lat: 41.3275, lng: 19.8187 },
            'tiranes': { lat: 41.3275, lng: 19.8187 },
            'tiran√´': { lat: 41.3275, lng: 19.8187 },
            'durres': { lat: 41.3231, lng: 19.4565 },
            'durr√´s': { lat: 41.3231, lng: 19.4565 },
            'durr√´si': { lat: 41.3231, lng: 19.4565 },
            'vlore': { lat: 40.4667, lng: 19.4833 },
            'vlor√´': { lat: 40.4667, lng: 19.4833 },
            'vlora': { lat: 40.4667, lng: 19.4833 },
            'shkoder': { lat: 42.0683, lng: 19.5128 },
            'shkod√´r': { lat: 42.0683, lng: 19.5128 },
            'shkodra': { lat: 42.0683, lng: 19.5128 },
            'elbasan': { lat: 41.1125, lng: 20.0822 },
            'elbasani': { lat: 41.1125, lng: 20.0822 },
            'korce': { lat: 40.6186, lng: 20.7811 },
            'kor√ß√´': { lat: 40.6186, lng: 20.7811 },
            'korca': { lat: 40.6186, lng: 20.7811 },
            'fier': { lat: 40.7239, lng: 19.5558 },
            'fieri': { lat: 40.7239, lng: 19.5558 },
            'berat': { lat: 40.7058, lng: 19.9522 },
            'berati': { lat: 40.7058, lng: 19.9522 },
            'lushnje': { lat: 40.9417, lng: 19.7028 },
            'lushnj√´': { lat: 40.9417, lng: 19.7028 },
            'lushnja': { lat: 40.9417, lng: 19.7028 },
            'kavaje': { lat: 41.1856, lng: 19.5575 },
            'kavaj√´': { lat: 41.1856, lng: 19.5575 },
            'kavaja': { lat: 41.1856, lng: 19.5575 },
            'pogradec': { lat: 40.9019, lng: 20.6528 },
            'pogradeci': { lat: 40.9019, lng: 20.6528 },
            'gjirokaster': { lat: 40.0758, lng: 20.1392 },
            'gjirokast√´r': { lat: 40.0758, lng: 20.1392 },
            'gjirokastra': { lat: 40.0758, lng: 20.1392 },
            'sarande': { lat: 39.8597, lng: 20.0089 },
            'sarand√´': { lat: 39.8597, lng: 20.0089 },
            'saranda': { lat: 39.8597, lng: 20.0089 },
            
            // NEW: Additional districts and towns (+40 locations)
            'kukes': { lat: 42.0778, lng: 20.4178 },
            'kuk√´s': { lat: 42.0778, lng: 20.4178 },
            'kukesi': { lat: 42.0778, lng: 20.4178 },
            'lezhe': { lat: 41.7836, lng: 19.6436 },
            'lezh√´': { lat: 41.7836, lng: 19.6436 },
            'lezha': { lat: 41.7836, lng: 19.6436 },
            'lac': { lat: 41.6358, lng: 19.7133 },
            'la√ß': { lat: 41.6358, lng: 19.7133 },
            'laci': { lat: 41.6358, lng: 19.7133 },
            'patos': { lat: 40.6406, lng: 19.6200 },
            'patosi': { lat: 40.6406, lng: 19.6200 },
            'kruje': { lat: 41.5089, lng: 19.7928 },
            'kruj√´': { lat: 41.5089, lng: 19.7928 },
            'kruja': { lat: 41.5089, lng: 19.7928 },
            'kucove': { lat: 40.7997, lng: 19.9169 },
            'ku√ßove': { lat: 40.7997, lng: 19.9169 },
            'ku√ßova': { lat: 40.7997, lng: 19.9169 },
            'burrel': { lat: 41.6103, lng: 20.0089 },
            'burreli': { lat: 41.6103, lng: 20.0089 },
            'peshkopi': { lat: 41.6850, lng: 20.4289 },
            'peshkopia': { lat: 41.6850, lng: 20.4289 },
            'divjake': { lat: 40.9986, lng: 19.5297 },
            'divjak√´': { lat: 40.9986, lng: 19.5297 },
            'divjaka': { lat: 40.9986, lng: 19.5297 },
            'fushe-kruje': { lat: 41.4786, lng: 19.7167 },
            'fushe kruje': { lat: 41.4786, lng: 19.7167 },
            'fush√´-kruj√´': { lat: 41.4786, lng: 19.7167 },
            'gramsh': { lat: 40.8697, lng: 20.1844 },
            'gramshi': { lat: 40.8697, lng: 20.1844 },
            'librazhd': { lat: 41.1828, lng: 20.3172 },
            'librazhdi': { lat: 41.1828, lng: 20.3172 },
            'tepelene': { lat: 40.2975, lng: 20.0189 },
            'tepelen√´': { lat: 40.2975, lng: 20.0189 },
            'tepelena': { lat: 40.2975, lng: 20.0189 },
            'bulqize': { lat: 41.4911, lng: 20.2219 },
            'bulqiz√´': { lat: 41.4911, lng: 20.2219 },
            'bulqiza': { lat: 41.4911, lng: 20.2219 },
            'permet': { lat: 40.2333, lng: 20.3500 },
            'p√´rmet': { lat: 40.2333, lng: 20.3500 },
            'permeti': { lat: 40.2333, lng: 20.3500 },
            'delvine': { lat: 39.9503, lng: 20.0983 },
            'delvin√´': { lat: 39.9503, lng: 20.0983 },
            'delvina': { lat: 39.9503, lng: 20.0983 },
            'rreshen': { lat: 41.7669, lng: 19.8831 },
            'rresheni': { lat: 41.7669, lng: 19.8831 },
            'ballsh': { lat: 40.5989, lng: 19.7333 },
            'ballshi': { lat: 40.5989, lng: 19.7333 },
            'mamurras': { lat: 41.5775, lng: 19.6919 },
            'mamurrasi': { lat: 41.5775, lng: 19.6919 },
            'bajram curri': { lat: 42.3578, lng: 20.0753 },
            'bajramcurri': { lat: 42.3578, lng: 20.0753 },
            'erseke': { lat: 40.3375, lng: 20.6786 },
            'ersek√´': { lat: 40.3375, lng: 20.6786 },
            'erseka': { lat: 40.3375, lng: 20.6786 },
            'peqin': { lat: 41.0456, lng: 19.7506 },
            'peqini': { lat: 41.0456, lng: 19.7506 },
            'bilisht': { lat: 40.6275, lng: 20.9886 },
            'bilishti': { lat: 40.6275, lng: 20.9886 },
            'roskovec': { lat: 40.7389, lng: 19.7022 },
            'roskoveci': { lat: 40.7389, lng: 19.7022 },
            'puke': { lat: 42.0428, lng: 19.8992 },
            'puk√´': { lat: 42.0428, lng: 19.8992 },
            'puka': { lat: 42.0428, lng: 19.8992 },
            'rrogozhine': { lat: 41.0756, lng: 19.6608 },
            'rrogozhin√´': { lat: 41.0756, lng: 19.6608 },
            'rrogozhina': { lat: 41.0756, lng: 19.6608 },
            'vore': { lat: 41.3961, lng: 19.6486 },
            'vor√´': { lat: 41.3961, lng: 19.6486 },
            'vora': { lat: 41.3961, lng: 19.6486 },
            'kamze': { lat: 41.3814, lng: 19.7628 },
            'kamz√´': { lat: 41.3814, lng: 19.7628 },
            'kamza': { lat: 41.3814, lng: 19.7628 },
            'kamez': { lat: 41.3814, lng: 19.7628 },
            'himare': { lat: 40.1017, lng: 19.7447 },
            'himar√´': { lat: 40.1017, lng: 19.7447 },
            'himara': { lat: 40.1017, lng: 19.7447 },
            'konispol': { lat: 39.6578, lng: 20.1814 },
            'konispoli': { lat: 39.6578, lng: 20.1814 },
            'selenice': { lat: 40.5306, lng: 19.6386 },
            'selenic√´': { lat: 40.5306, lng: 19.6386 },
            'selenica': { lat: 40.5306, lng: 19.6386 },
            'memaliaj': { lat: 40.3508, lng: 19.9800 },
            'memaliaji': { lat: 40.3508, lng: 19.9800 },
            'kelcyre': { lat: 40.3086, lng: 20.1892 },
            'kelcyr√´': { lat: 40.3086, lng: 20.1892 },
            'kelcyra': { lat: 40.3086, lng: 20.1892 },
            'maliq': { lat: 40.7050, lng: 20.6981 },
            'maliqi': { lat: 40.7050, lng: 20.6981 },
            'prrenjas': { lat: 41.0581, lng: 20.3486 },
            'prrenjasi': { lat: 41.0581, lng: 20.3486 },
            'cerrik': { lat: 41.0331, lng: 19.9750 },
            'c√´rrik': { lat: 41.0331, lng: 19.9750 },
            'cerriku': { lat: 41.0331, lng: 19.9750 },
            'belsh': { lat: 40.9942, lng: 20.0422 },
            'belshi': { lat: 40.9942, lng: 20.0422 },
            'polican': { lat: 40.6122, lng: 20.0983 },
            'poli√ßan': { lat: 40.6122, lng: 20.0983 },
            'skrapar': { lat: 40.5344, lng: 20.2683 },
            'skrapari': { lat: 40.5344, lng: 20.2683 },
            'ura vajgurore': { lat: 40.7667, lng: 19.8833 },
            'klos': { lat: 41.5042, lng: 20.0864 },
            'klosi': { lat: 41.5042, lng: 20.0864 },
            'mat': { lat: 41.6000, lng: 20.0000 },
            'mati': { lat: 41.6000, lng: 20.0000 },
            'mirdite': { lat: 41.7669, lng: 19.8831 },
            'mirdit√´': { lat: 41.7669, lng: 19.8831 },
            'finiq': { lat: 39.8722, lng: 20.0989 },
            'finiqi': { lat: 39.8722, lng: 20.0989 },
            'dropull': { lat: 40.0500, lng: 20.4167 },
            'dropulli': { lat: 40.0500, lng: 20.4167 },
            'libohove': { lat: 40.0328, lng: 20.2656 },
            'libohov√´': { lat: 40.0328, lng: 20.2656 },
            'libohova': { lat: 40.0328, lng: 20.2656 },
            'kolonje': { lat: 40.3333, lng: 20.6667 },
            'kolonj√´': { lat: 40.3333, lng: 20.6667 },
            'devoll': { lat: 40.6275, lng: 20.9886 },
            'devolli': { lat: 40.6275, lng: 20.9886 },
            'has': { lat: 42.2833, lng: 20.3667 },
            'hasi': { lat: 42.2833, lng: 20.3667 },
            'tropoje': { lat: 42.3978, lng: 20.1653 },
            'tropoj√´': { lat: 42.3978, lng: 20.1653 },
            'tropoja': { lat: 42.3978, lng: 20.1653 },
            'malesia e madhe': { lat: 42.3333, lng: 19.6833 },
            'mal√´sia e madhe': { lat: 42.3333, lng: 19.6833 },
            'vau i dejes': { lat: 42.0139, lng: 19.6450 },
            'vau dejes': { lat: 42.0139, lng: 19.6450 }
        };

        // Add random offset to prevent marker stacking (2km radius)
        const addJitter = (lat, lng, radiusKm = 2) => {
            const latOffset = (Math.random() - 0.5) * (radiusKm / 111);
            const lngOffset = (Math.random() - 0.5) * (radiusKm / (111 * Math.cos(lat * Math.PI / 180)));
            return { 
                lat: lat + latOffset, 
                lng: lng + lngOffset 
            };
        };

        // ENHANCED: Smarter city extraction with fuzzy matching and aggressive normalization
        const extractCity = (address) => {
            if (!address) return null;
            
            // Aggressive normalization
            const normalizeText = (text) => {
                return text
                    .toLowerCase()
                    .trim()
                    // Remove common prefixes/suffixes
                    .replace(/\b(rruga|rr\.|street|st\.|lagja|zona|qyteti|qendra|center)\b/g, '')
                    // Normalize Albanian characters
                    .replace(/√´/g, 'e')
                    .replace(/√ß/g, 'c')
                    // Remove special characters but keep spaces
                    .replace(/[^a-z0-9\s]/g, ' ')
                    // Remove multiple spaces
                    .replace(/\s+/g, ' ')
                    .trim();
            };
            
            const addr = normalizeText(address);
            
            // Strategy 1: Exact match (after normalization)
            for (const [city, coords] of Object.entries(CITY_COORDINATES)) {
                const normalizedCity = normalizeText(city);
                if (addr === normalizedCity || addr.includes(` ${normalizedCity} `) || addr.startsWith(normalizedCity + ' ') || addr.endsWith(' ' + normalizedCity)) {
                    return city;
                }
            }
            
            // Strategy 2: Partial word match (at least 4 chars)
            for (const [city, coords] of Object.entries(CITY_COORDINATES)) {
                const normalizedCity = normalizeText(city);
                if (normalizedCity.length >= 4 && addr.includes(normalizedCity)) {
                    return city;
                }
            }
            
            // Strategy 3: Fuzzy match (first 5 characters)
            const addrWords = addr.split(' ');
            for (const word of addrWords) {
                if (word.length >= 5) {
                    for (const [city, coords] of Object.entries(CITY_COORDINATES)) {
                        const normalizedCity = normalizeText(city);
                        if (normalizedCity.length >= 5) {
                            const wordPrefix = word.substring(0, 5);
                            const cityPrefix = normalizedCity.substring(0, 5);
                            if (wordPrefix === cityPrefix) {
                                return city;
                            }
                        }
                    }
                }
            }
            
            // Strategy 4: Check if city appears after comma (common in Albanian addresses)
            const parts = address.split(',').map(p => normalizeText(p));
            for (const part of parts) {
                for (const [city, coords] of Object.entries(CITY_COORDINATES)) {
                    const normalizedCity = normalizeText(city);
                    if (part.trim() === normalizedCity || part.includes(normalizedCity)) {
                        return city;
                    }
                }
            }
            
            return null; // Will trigger catch-all fallback
        };

        // AGGRESSIVE: Smart geocoding with guaranteed placement (zero data loss)
        const geocodeAddressSmart = async (order) => {
            const address = order.address || order.deliveryAddress;
            
            // Fallback 1: No address ‚Üí use city field
            if (!address) {
                const city = extractCity(order.city);
                if (city && CITY_COORDINATES[city]) {
                    return {
                        ...addJitter(CITY_COORDINATES[city].lat, CITY_COORDINATES[city].lng),
                        type: 'city-field' // Marker color: yellow
                    };
                }
                // Catch-all for missing address
                return {
                    ...addJitter(41.1533, 20.1683, 5), // Central Albania with high jitter
                    type: 'unknown' // Marker color: gray
                };
            }

            // Check cache first (instant)
            const cacheKey = address.toLowerCase().trim();
            if (addressCache[cacheKey]) {
                return {
                    ...addJitter(addressCache[cacheKey].lat, addressCache[cacheKey].lng, 0.5),
                    type: 'cached' // Marker color: green
                };
            }

            // Try city extraction (fast path)
            const city = extractCity(address);
            if (city && CITY_COORDINATES[city]) {
                const coords = CITY_COORDINATES[city];
                addressCache[cacheKey] = coords;
                return {
                    ...addJitter(coords.lat, coords.lng),
                    type: 'city-match' // Marker color: yellow
                };
            }

            // Check if order qualifies for API geocoding (high-value or specific flag)
            if (order.price && order.price > 50) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 1100));
                    const query = `${address}, Albania`;
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=al&limit=1`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            const coords = { 
                                lat: parseFloat(data[0].lat), 
                                lng: parseFloat(data[0].lon) 
                            };
                            addressCache[cacheKey] = coords;
                            localStorage.setItem('danfosal_address_cache', JSON.stringify(addressCache));
                            return {
                                ...coords,
                                type: 'api' // Marker color: green (precise)
                            };
                        }
                    }
                } catch (error) {
                    console.warn(`Geocoding failed for: ${address}`, error);
                }
            }

            // CATCH-ALL: Map to Tirana with high jitter (better than hiding)
            console.log(`‚ö†Ô∏è Catch-all fallback for: ${address.substring(0, 30)}...`);
            return {
                ...addJitter(41.3275, 19.8187, 4), // Tirana with 4km jitter
                type: 'catch-all' // Marker color: blue/gray
            };
        };

        // --- Map Initialization ---
        const initMap = () => {
            map = L.map('map', {
                center: [41.3275, 19.8187], // Center on Albania (Tirana)
                zoom: 7,
                zoomControl: false,
                attributionControl: false
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            markerCluster = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({ 
                        html: `<div style="background: rgba(74, 222, 128, 0.2); border: 1px solid #4ade80; color: #fff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${cluster.getChildCount()}</div>`, 
                        className: 'custom-cluster-icon', 
                        iconSize: [30, 30] 
                    });
                }
            });
            map.addLayer(markerCluster);
        };

        const updateMap = async () => {
            console.log('üöÄ updateMap() called');
            
            try {
                // Clear old state
                if (markerCluster) markerCluster.clearLayers();
                if (heatLayer) map.removeLayer(heatLayer);
                processedOrderIds.clear();
                
                console.log('‚úÖ Cleared old markers');

                // Filter orders by date range
                let startDate;
                if (currentDaysFilter !== 'all') {
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - parseInt(currentDaysFilter));
                }
                
                const filteredOrders = currentDaysFilter === 'all' 
                    ? allOrdersData 
                    : allOrdersData.filter(order => {
                        const d = getDate(order.timestamp);
                        return d.getTime() >= startDate.getTime();
                    });

                // FILTER: Only include orders with addresses (exclude store sales without location data)
                const ordersWithLocation = filteredOrders.filter(order => 
                    (order.address && order.address.trim()) || (order.city && order.city.trim())
                );
                
                const excludedCount = filteredOrders.length - ordersWithLocation.length;

                console.log(`üìä Total orders in dataset: ${allOrdersData.length}`);
                console.log(`üìä Filtered orders (${currentDaysFilter} days): ${filteredOrders.length}`);
                console.log(`üìç Orders with location data: ${ordersWithLocation.length}`);
                console.log(`üö´ Excluded from map (no address): ${excludedCount} (${(excludedCount/filteredOrders.length*100).toFixed(1)}%)`);

                const heatData = [];
                let processedCount = 0;
                let skippedDuplicates = 0;

                console.log(`üó∫Ô∏è Processing ${ordersWithLocation.length} orders for map...`);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // PHASE 1: INSTANT CITY-BASED RENDERING (90% of orders)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const cityOrders = [];
            const unknownOrders = [];

            for (const order of ordersWithLocation) {
                if (processedOrderIds.has(order.id)) {
                    skippedDuplicates++;
                    continue;
                }

                const city = extractCity(order.address || order.city);
                if (city && CITY_COORDINATES[city]) {
                    cityOrders.push(order);
                } else {
                    unknownOrders.push(order); // ALL non-city orders go here (even without address)
                }
            }

            console.log(`üìã Batch Separation: ${cityOrders.length} city orders, ${unknownOrders.length} unknown orders`);

            // Render city-based orders immediately
            for (const order of cityOrders) {
                if (processedOrderIds.has(order.id)) continue;
                
                const result = await geocodeAddressSmart(order);
                if (result) {
                    processedOrderIds.add(order.id);
                    processedCount++;

                    heatData.push([result.lat, result.lng, 1]);
                    
                    // Color based on type
                    let markerColor = '#4ade80'; // Default green
                    let markerLabel = '';
                    if (result.type === 'city-match' || result.type === 'city-field') {
                        markerColor = '#facc15'; // Yellow (city center)
                        markerLabel = 'üìç';
                    } else if (result.type === 'catch-all' || result.type === 'unknown') {
                        markerColor = '#94a3b8'; // Gray (unknown)
                        markerLabel = '‚ùì';
                    }
                    
                    const marker = L.marker([result.lat, result.lng], {
                        icon: L.divIcon({
                            html: `<div style="background: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #050b07; box-shadow: 0 0 10px ${markerColor};"></div>`,
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    }).bindPopup(`
                        <div style="color: #000;">
                            <strong>${order.clientName || 'Customer'}</strong><br>
                            ${order.address || 'No address'}<br>
                            ‚Ç¨${(order.price || 0).toFixed(2)}<br>
                            <span style="font-size: 10px; color: #666;">${markerLabel} ${result.type}</span>
                        </div>
                    `);
                    
                    markerCluster.addLayer(marker);
                }
            }

            console.log(`‚úÖ Phase 1: Rendered ${processedCount} city-based orders`);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // PHASE 2: HIGH-VALUE API GEOCODING (Top 200 by price)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const sortedUnknown = unknownOrders.sort((a, b) => (b.price || 0) - (a.price || 0));
            const apiOrders = sortedUnknown.slice(0, 200);
            
            console.log(`üîç Phase 2: Processing ${apiOrders.length} high-value orders...`);
            
            for (const order of apiOrders) {
                if (processedOrderIds.has(order.id)) continue;
                
                const result = await geocodeAddressSmart(order);
                if (result) {
                    processedOrderIds.add(order.id);
                    processedCount++;

                    heatData.push([result.lat, result.lng, 1]);
                    
                    // Color based on type
                    let markerColor = '#a855f7'; // Purple (API)
                    let markerLabel = 'üéØ';
                    if (result.type === 'catch-all' || result.type === 'unknown') {
                        markerColor = '#94a3b8'; // Gray
                        markerLabel = '‚ùì';
                    }
                    
                    const marker = L.marker([result.lat, result.lng], {
                        icon: L.divIcon({
                            html: `<div style="background: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #050b07; box-shadow: 0 0 10px ${markerColor};"></div>`,
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    }).bindPopup(`
                        <div style="color: #000;">
                            <strong>${order.clientName || 'Customer'}</strong><br>
                            ${order.address || 'No address'}<br>
                            ‚Ç¨${(order.price || 0).toFixed(2)}<br>
                            <span style="font-size: 10px; color: #666;">${markerLabel} ${result.type}</span>
                        </div>
                    `);
                    
                    markerCluster.addLayer(marker);
                }
            }

            console.log(`‚úÖ Phase 2: Geocoded ${apiOrders.length} high-value orders (${processedCount - cityOrders.length} successful)`);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // PHASE 3: CATCH-ALL FALLBACK (ALL remaining orders)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const remainingOrders = sortedUnknown.slice(200);
            
            console.log(`üì¶ Phase 3: Rendering ${remainingOrders.length} fallback orders (GUARANTEED PLACEMENT)...`);
            
            if (remainingOrders.length > 0) {
                
                for (const order of remainingOrders) {
                    if (processedOrderIds.has(order.id)) continue;
                    
                    // Force catch-all fallback (skip API calls) - GUARANTEED PLACEMENT
                    const result = addJitter(41.1533, 20.1683, 5); // Central Albania, 5km radius
                    
                    processedOrderIds.add(order.id);
                    processedCount++;

                    heatData.push([result.lat, result.lng, 1]);
                    
                    const marker = L.marker([result.lat, result.lng], {
                        icon: L.divIcon({
                            html: `<div style="background: #94a3b8; width: 10px; height: 10px; border-radius: 50%; border: 2px solid #050b07; box-shadow: 0 0 8px #94a3b8;"></div>`,
                            iconSize: [10, 10],
                            iconAnchor: [5, 5]
                        })
                    }).bindPopup(`
                        <div style="color: #000;">
                            <strong>${order.clientName || 'Customer'}</strong><br>
                            ${order.address || 'General Location'}<br>
                            ‚Ç¨${(order.price || 0).toFixed(2)}<br>
                            <span style="font-size: 10px; color: #666;">‚ùì Approximate location</span>
                        </div>
                    `);
                    
                    markerCluster.addLayer(marker);
                }
                
                console.log(`‚úÖ Phase 3: Rendered ${remainingOrders.length} fallback orders`);
            }

            // Add heat layer
            if (heatData.length > 0) {
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: { 0.4: '#4ade80', 0.65: '#a855f7', 1: '#f43f5e' }
                }).addTo(map);
                
                // Fit bounds to show all points
                if (markerCluster.getBounds().isValid()) {
                    map.fitBounds(markerCluster.getBounds(), { padding: [50, 50] });
                }
            }

            // Detailed logging
            console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
            console.log(`‚úÖ COMPLETE: Rendered ${processedCount} / ${ordersWithLocation.length} orders with addresses`);
            console.log(`‚ö†Ô∏è Skipped ${skippedDuplicates} duplicates`);
            console.log(`üö´ Excluded ${excludedCount} store sales (no location data)`);
            console.log(`üìä Coverage: ${((processedCount / ordersWithLocation.length) * 100).toFixed(1)}%`);
            
            if (processedCount < ordersWithLocation.length) {
                console.error(`‚ùå MISSING ${ordersWithLocation.length - processedCount} ORDERS!`);
                console.log(`üîç Debugging Info:`);
                console.log(`   - Total with Location: ${ordersWithLocation.length}`);
                console.log(`   - City Orders: ${cityOrders.length}`);
                console.log(`   - Unknown Orders: ${unknownOrders.length}`);
                console.log(`   - API Batch: ${apiOrders.length}`);
                console.log(`   - Fallback: ${remainingOrders.length}`);
                console.log(`   - Processed: ${processedCount}`);
                console.log(`   - Expected: ${cityOrders.length + unknownOrders.length}`);
            }
            
            console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
            console.log(`üé® LEGEND:`);
            console.log(`   üü° Yellow: City Center (${cityOrders.length} orders)`);
            console.log(`   üü£ Purple: Precise Geocoded (${Math.min(apiOrders.length, 200)} orders)`);
            console.log(`   ‚ö™ Gray: Approximate Location (${remainingOrders.length || 0} orders)`);
            console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
            
            } catch (error) {
                console.error('‚ùå CRITICAL ERROR in updateMap():', error);
                console.error('Stack trace:', error.stack);
                alert('Map rendering failed. Check console for details.');
            }
        };

        // --- Chart Rendering ---
        const destroyCharts = () => {
            Object.values(charts).forEach(chart => { if (chart) chart.destroy(); });
        };

        const renderChart = (id, type, labels, data, label, backgroundColors, isLine = false) => {
            const ctx = document.getElementById(id).getContext('2d');
            
            let bg = backgroundColors;
            if (isLine) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(74, 222, 128, 0.5)');
                gradient.addColorStop(1, 'rgba(74, 222, 128, 0)');
                bg = gradient;
            }

            charts[id] = new Chart(ctx, {
                type: type,
                data: { 
                    labels, 
                    datasets: [{ 
                        label, 
                        data, 
                        backgroundColor: bg, 
                        borderColor: isLine ? '#4ade80' : 'transparent', 
                        borderWidth: isLine ? 2 : 0, 
                        fill: isLine,
                        tension: 0.4,
                        pointBackgroundColor: '#050b07',
                        pointBorderColor: '#4ade80',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }] 
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: !isLine, labels: { color: '#9ca3af', font: { family: 'Manrope' } } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 31, 21, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true
                        }
                    },
                    scales: { 
                        y: { 
                            display: isLine,
                            beginAtZero: true, 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#6b7280', font: { family: 'Manrope' } } 
                        }, 
                        x: { 
                            display: isLine,
                            grid: { display: false }, 
                            ticks: { color: '#6b7280', font: { family: 'Manrope' } } 
                        } 
                    },
                    cutout: type === 'doughnut' ? '70%' : 0
                }
            });
        };

        // --- Main Update Logic ---
        window.scrollToSection = (id) => {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        window.updateAnalytics = () => {
            destroyCharts();

            // Filter Data
            let startDate;
            if (currentDaysFilter !== 'all') {
                startDate = new Date();
                startDate.setDate(startDate.getDate() - parseInt(currentDaysFilter));
            }
            
            const filteredOrders = currentDaysFilter === 'all' 
                ? allOrdersData 
                : allOrdersData.filter(order => {
                    const d = getDate(order.timestamp);
                    return d.getTime() >= startDate.getTime();
                });
            
            const paidOrders = filteredOrders.filter(order => order.status === 'Paid');

            // 1. Update KPI Cards
            const totalRevenue = paidOrders.reduce((sum, order) => sum + order.price, 0);
            const totalCost = paidOrders.reduce((sum, order) => sum + (order.cost || 0) + (order.courierCost || 0), 0);
            const totalProfit = totalRevenue - totalCost;
            const avgOrderValue = paidOrders.length > 0 ? totalRevenue / paidOrders.length : 0;

            document.getElementById('kpi-revenue').textContent = `‚Ç¨${totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('kpi-profit').textContent = `‚Ç¨${totalProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('kpi-avg-order').textContent = `‚Ç¨${avgOrderValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('kpi-acquisition').textContent = filteredOrders.length;

            // 2. Revenue Chart (Line) - Group by YYYY-MM
            const monthlyRevenue = paidOrders.reduce((acc, order) => {
                const date = getDate(order.paidTimestamp || order.timestamp);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                acc[key] = (acc[key] || 0) + order.price;
                return acc;
            }, {});
            
            const sortedKeys = Object.keys(monthlyRevenue).sort();
            const labels = sortedKeys.map(key => {
                const [y, m] = key.split('-');
                const d = new Date(y, m - 1);
                return d.toLocaleString('default', { month: 'short', year: 'numeric' });
            });
            const data = sortedKeys.map(k => monthlyRevenue[k]);
            
            renderChart('revenueChart', 'line', labels, data, 'Revenue (‚Ç¨)', null, true);

            // 3. Acquisition Chart (Doughnut - Order Status)
            const statusCounts = filteredOrders.reduce((acc, order) => { 
                const status = order.status || 'Unknown'; 
                acc[status] = (acc[status] || 0) + 1; 
                return acc; 
            }, {});
            renderChart('acquisitionChart', 'doughnut', Object.keys(statusCounts), Object.values(statusCounts), 'Orders', ['#4ade80', '#a855f7', '#3b82f6', '#f43f5e', '#facc15']);
            document.getElementById('chart-total-orders').textContent = filteredOrders.length;

            // 4. Top Products List (Sorted by Revenue)
            const productCounts = filteredOrders.reduce((acc, order) => {
                (order.items || []).forEach(item => {
                    acc[item.name] = (acc[item.name] || 0) + item.quantity;
                    acc[item.name + '_rev'] = (acc[item.name + '_rev'] || 0) + (item.price * item.quantity);
                });
                return acc;
            }, {});
            
            const uniqueProducts = Object.keys(productCounts).filter(k => !k.endsWith('_rev'));
            // Sort by Revenue instead of Quantity
            const sortedProducts = uniqueProducts.sort((a, b) => productCounts[b + '_rev'] - productCounts[a + '_rev']).slice(0, 5);
            const maxRevenue = sortedProducts.length > 0 ? productCounts[sortedProducts[0] + '_rev'] : 1;

            const productsListHtml = sortedProducts.map(name => {
                const count = productCounts[name];
                const revenue = productCounts[name + '_rev'];
                const percentage = (revenue / maxRevenue) * 100;
                
                return `
                <div class="flex items-center gap-4 group p-2 -mx-2 rounded-xl hover:bg-white/5 transition-colors cursor-pointer">
                    <div class="size-10 rounded-lg bg-surface-dark border border-white/10 flex items-center justify-center text-white/20 shrink-0">
                        <span class="material-symbols-outlined text-lg">inventory_2</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h4 class="text-sm font-bold text-white truncate group-hover:text-primary transition-colors">${name}</h4>
                            <span class="text-xs font-mono text-primary font-bold">‚Ç¨${revenue.toFixed(0)}</span>
                        </div>
                        <div class="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-gradient-to-r from-primary to-emerald-400 h-full rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-[10px] text-white/40 mt-1">${count} units sold</p>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('top-products-list').innerHTML = productsListHtml || '<p class="text-white/40 text-sm p-4">No sales data available.</p>';

            // 5. Top Locations List
            const cityMapping = {
                'tirana': 'Tirana', 'tirane': 'Tirana', 'tiran√´': 'Tirana',
                'durres': 'Durres', 'durr√´s': 'Durres', 'durresi': 'Durres',
                'vlore': 'Vlore', 'vlor√´': 'Vlore', 'vlora': 'Vlore',
                'shkoder': 'Shkoder', 'shkod√´r': 'Shkoder', 'shkodra': 'Shkoder',
                'elbasan': 'Elbasan',
                'fier': 'Fier',
                'korce': 'Korce', 'kor√ß√´': 'Korce', 'korca': 'Korce',
                'berat': 'Berat',
                'lushnje': 'Lushnje', 'lushnj√´': 'Lushnje', 'lushnja': 'Lushnje',
                'kavaje': 'Kavaje', 'kavaj√´': 'Kavaje', 'kavaja': 'Kavaje',
                'lezhe': 'Lezhe', 'lezh√´': 'Lezhe', 'lezha': 'Lezhe',
                'kukes': 'Kukes', 'kuk√´s': 'Kukes', 'kukesi': 'Kukes',
                'sarande': 'Sarande', 'sarand√´': 'Sarande', 'saranda': 'Sarande',
                'gjirokaster': 'Gjirokaster', 'gjirokast√´r': 'Gjirokaster', 'gjirokastra': 'Gjirokaster',
                'pogradec': 'Pogradec', 'pogradeci': 'Pogradec',
                'lac': 'La√ß', 'la√ß': 'La√ß', 'laci': 'La√ß',
                'patos': 'Patos',
                'kruje': 'Kruje', 'kruj√´': 'Kruje', 'kruja': 'Kruje',
                'kucove': 'Ku√ßove', 'ku√ßove': 'Ku√ßove', 'ku√ßova': 'Ku√ßove',
                'burrel': 'Burrel', 'burreli': 'Burrel',
                'peshkopi': 'Peshkopi', 'peshkopia': 'Peshkopi',
                'divjake': 'Divjake', 'divjak√´': 'Divjake', 'divjaka': 'Divjake',
                'fushe-kruje': 'Fushe-Kruje', 'fushe kruje': 'Fushe-Kruje', 'fush√´-kruj√´': 'Fushe-Kruje',
                'gramsh': 'Gramsh', 'gramshi': 'Gramsh',
                'librazhd': 'Librazhd', 'librazhdi': 'Librazhd',
                'tepelene': 'Tepelene', 'tepelen√´': 'Tepelene', 'tepelena': 'Tepelene',
                'bulqize': 'Bulqize', 'bulqiz√´': 'Bulqize', 'bulqiza': 'Bulqize',
                'permet': 'Permet', 'p√´rmet': 'Permet', 'permeti': 'Permet',
                'delvine': 'Delvine', 'delvin√´': 'Delvine', 'delvina': 'Delvine',
                'rreshen': 'Rreshen', 'rresheni': 'Rreshen',
                'ballsh': 'Ballsh', 'ballshi': 'Ballsh',
                'mamurras': 'Mamurras',
                'bajram curri': 'Bajram Curri',
                'erseke': 'Erseke', 'ersek√´': 'Erseke', 'erseka': 'Erseke',
                'peqin': 'Peqin', 'peqini': 'Peqin',
                'bilisht': 'Bilisht', 'bilishti': 'Bilisht',
                'roskovec': 'Roskovec',
                'puke': 'Puke', 'puk√´': 'Puke', 'puka': 'Puke',
                'rrogozhine': 'Rrogozhine', 'rrogozhin√´': 'Rrogozhine', 'rrogozhina': 'Rrogozhine',
                'vore': 'Vore', 'vor√´': 'Vore', 'vora': 'Vore',
                'kamze': 'Kamze', 'kamz√´': 'Kamze', 'kamza': 'Kamze', 'kamez': 'Kamze',
                'himare': 'Himare', 'himar√´': 'Himare', 'himara': 'Himare',
                'konispol': 'Konispol',
                'selenice': 'Selenice', 'selenic√´': 'Selenice', 'selenica': 'Selenice',
                'memaliaj': 'Memaliaj',
                'kelcyre': 'Kelcyre', 'kelcyr√´': 'Kelcyre', 'kelcyra': 'Kelcyre',
                'maliq': 'Maliq', 'maliqi': 'Maliq',
                'prrenjas': 'Prrenjas',
                'cerrik': 'Cerrik', 'c√´rrik': 'Cerrik',
                'belsh': 'Belsh', 'belshi': 'Belsh',
                'polican': 'Polican', 'poli√ßan': 'Polican',
                'skrapar': 'Skrapar',
                'ura vajgurore': 'Ura Vajgurore',
                'klos': 'Klos',
                'mat': 'Mat',
                'mirdite': 'Mirdite', 'mirdit√´': 'Mirdite',
                'finiq': 'Finiq',
                'dropull': 'Dropull',
                'libohove': 'Libohove', 'libohov√´': 'Libohove', 'libohova': 'Libohove',
                'kolonje': 'Kolonje', 'kolonj√´': 'Kolonje',
                'devoll': 'Devoll',
                'has': 'Has',
                'tropoje': 'Tropoje', 'tropoj√´': 'Tropoje', 'tropoja': 'Tropoje',
                'malesia e madhe': 'Malesia e Madhe',
                'vau i dejes': 'Vau i Dejes'
            };

            const locationCounts = filteredOrders.reduce((acc, order) => {
                if (order.address) {
                    let address = order.address.toLowerCase();
                    let city = 'Other';
                    
                    // Strategy: Split by comma, check parts from end to beginning
                    // This avoids matching street names like "Rruga e Durresit" (in Tirana) as "Durres"
                    const parts = address.split(',');
                    let found = false;
                    
                    // Sort keys by length descending once
                    const sortedKeys = Object.keys(cityMapping).sort((a, b) => b.length - a.length);

                    // 1. Iterate parts from last to first (City is usually at the end)
                    for (let i = parts.length - 1; i >= 0; i--) {
                        const part = parts[i].trim();
                        
                        // Skip "Albania" or "Shqiperia" if it's the last part
                        if (['albania', 'shqiperia', 'shqip√´ria'].includes(part)) continue;

                        for (const key of sortedKeys) {
                            // Check if the part contains the city name
                            // We use word boundary check logic implicitly by checking inclusion in the part
                            if (part.includes(key)) {
                                city = cityMapping[key];
                                found = true;
                                break;
                            }
                        }
                        if (found) break;
                    }
                    
                    // 2. Fallback: If no match in parts (e.g. no commas), check whole string
                    // But prioritize Tirana to avoid "Rruga e Durresit" issue if Tirana is also present
                    if (!found) {
                        if (address.includes('tirana') || address.includes('tirane') || address.includes('tiran√´')) {
                            city = 'Tirana';
                        } else {
                            for (const key of sortedKeys) {
                                if (address.includes(key)) {
                                    city = cityMapping[key];
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (city !== 'Other') {
                        acc[city] = (acc[city] || 0) + order.price;
                    }
                }
                return acc;
            }, {});
            
            const sortedLocations = Object.keys(locationCounts).sort((a, b) => locationCounts[b] - locationCounts[a]).slice(0, 5);
            const maxLocRevenue = sortedLocations.length > 0 ? locationCounts[sortedLocations[0]] : 1;

            const locationsListHtml = sortedLocations.map(city => {
                const revenue = locationCounts[city];
                const percentage = (revenue / maxLocRevenue) * 100;
                
                return `
                <div class="flex items-center gap-4 group p-2 -mx-2 rounded-xl hover:bg-white/5 transition-colors cursor-pointer">
                    <div class="size-10 rounded-lg bg-purple-500/10 border border-purple-500/20 flex items-center justify-center text-purple-400 shrink-0">
                        <span class="material-symbols-outlined text-lg">location_city</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h4 class="text-sm font-bold text-white truncate group-hover:text-purple-400 transition-colors">${city}</h4>
                            <span class="text-xs font-mono text-purple-400 font-bold">‚Ç¨${revenue.toFixed(0)}</span>
                        </div>
                        <div class="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('top-locations-list').innerHTML = locationsListHtml || '<p class="text-white/40 text-sm p-4">No location data.</p>';

            // 6. Top Customers List
            const customerCounts = filteredOrders.reduce((acc, order) => {
                const name = order.clientName || 'Guest';
                acc[name] = (acc[name] || 0) + order.price;
                return acc;
            }, {});
            const sortedCustomers = Object.keys(customerCounts).sort((a, b) => customerCounts[b] - customerCounts[a]).slice(0, 5);
            
            const customersListHtml = sortedCustomers.map(name => {
                return `
                <div class="flex items-center justify-between p-2 -mx-2 rounded-xl hover:bg-white/5 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="size-8 rounded-full bg-blue-500/10 text-blue-400 flex items-center justify-center font-bold text-xs">
                            ${name.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-sm font-medium text-white/80">${name}</span>
                    </div>
                    <span class="text-sm font-mono font-bold text-white">‚Ç¨${customerCounts[name].toFixed(2)}</span>
                </div>`;
            }).join('');
            document.getElementById('top-customers-list').innerHTML = customersListHtml || '<p class="text-white/40 text-sm">No customer data.</p>';

            // 6. Transactions Table
            const recentOrders = [...filteredOrders].sort((a, b) => {
                return getDate(b.timestamp).getTime() - getDate(a.timestamp).getTime();
            }).slice(0, 10);
            
            const transactionsHtml = recentOrders.map(order => {
                let statusColor = 'bg-gray-500';
                if (order.status === 'Paid') statusColor = 'bg-green-500';
                if (order.status === 'Pending') statusColor = 'bg-yellow-500';
                if (order.status === 'Cancelled') statusColor = 'bg-red-500';

                return `
                <tr class="hover:bg-white/5 transition-colors group cursor-pointer">
                    <td class="px-6 py-3 font-mono text-xs text-white/50">${order.clientName || 'Guest'}</td>
                    <td class="px-6 py-3">
                        <div class="flex items-center gap-2">
                            <span class="size-1.5 rounded-full bg-purple-500 shadow-[0_0_5px_rgba(168,85,247,0.8)]"></span> 
                            <span class="text-xs font-medium">${order.source || 'Direct'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-xs font-bold text-white">‚Ç¨${order.price.toFixed(2)}</td>
                    <td class="px-6 py-3 text-center">
                        <div class="size-2 rounded-full ${statusColor} mx-auto shadow-[0_0_5px_rgba(34,197,94,0.8)]" title="${order.status}"></div>
                    </td>
                </tr>`;
            }).join('');
            document.getElementById('transactions-table-body').innerHTML = transactionsHtml;
        };

        // --- Debtors & Creditors Logic ---
        const updateDebtorsCreditors = async () => {
            // Debtors
            const debtorsRef = collection(db, 'debtors');
            onSnapshot(query(debtorsRef), async (snapshot) => {
                const debtors = [];
                for (const doc of snapshot.docs) {
                    const d = doc.data();
                    const invoicesSnap = await getDocs(collection(db, `debtors/${doc.id}/invoices`));
                    let balance = 0;
                    invoicesSnap.forEach(inv => balance += (inv.data().remainingBalance || 0));
                    if (balance > 0) debtors.push({ name: d.name, balance });
                }
                debtors.sort((a, b) => b.balance - a.balance);
                
                const debtorsHtml = debtors.slice(0, 5).map(d => `
                    <div class="flex items-center justify-between p-2 -mx-2 rounded-xl hover:bg-white/5 transition-colors">
                        <span class="text-sm font-medium text-white/80">${d.name}</span>
                        <span class="text-sm font-mono font-bold text-red-400">‚Ç¨${d.balance.toFixed(2)}</span>
                    </div>
                `).join('');
                document.getElementById('top-debtors-list').innerHTML = debtorsHtml || '<p class="text-white/40 text-sm">No outstanding debt.</p>';
            });

            // Creditors
            const creditorsRef = collection(db, 'creditors');
            onSnapshot(query(creditorsRef), async (snapshot) => {
                const creditors = [];
                for (const doc of snapshot.docs) {
                    const c = doc.data();
                    const invoicesSnap = await getDocs(collection(db, `creditors/${doc.id}/invoices`));
                    let balance = 0;
                    invoicesSnap.forEach(inv => balance += (inv.data().remainingBalance || 0));
                    if (balance > 0) creditors.push({ name: c.name, balance });
                }
                creditors.sort((a, b) => b.balance - a.balance);

                const creditorsHtml = creditors.slice(0, 5).map(c => `
                    <div class="flex items-center justify-between p-2 -mx-2 rounded-xl hover:bg-white/5 transition-colors">
                        <span class="text-sm font-medium text-white/80">${c.name}</span>
                        <span class="text-sm font-mono font-bold text-yellow-400">‚Ç¨${c.balance.toFixed(2)}</span>
                    </div>
                `).join('');
                document.getElementById('top-creditors-list').innerHTML = creditorsHtml || '<p class="text-white/40 text-sm">No outstanding bills.</p>';
            });
        };

        // --- Initialization ---
        const startApp = async () => {
            
            console.log('üöÄ startApp() called');
            
            // Load Address Cache from LocalStorage (still useful for Map API limits)
            const cachedAddress = localStorage.getItem('danfosal_address_cache');
            if (cachedAddress) {
                try {
                    const parsed = JSON.parse(cachedAddress);
                    Object.assign(addressCache, parsed);
                    console.log(`‚úÖ Loaded ${Object.keys(parsed).length} cached addresses`);
                } catch (e) { console.error("Address cache error", e); }
            }

            console.log('üó∫Ô∏è Initializing map...');
            initMap();
            console.log('‚úÖ Map initialized');
            
            // 2. Listen for Online Orders (Persistence handled by Firebase)
            console.log('üì° Setting up Firebase listeners...');
            onSnapshot(collection(db, 'onlineOrders'), (snapshot) => {
                console.log(`üì¶ Online orders snapshot: ${snapshot.docs.length} documents`);
                onlineOrdersData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) data.timestamp = data.timestamp.toDate().getTime();
                    if (data.paidTimestamp && data.paidTimestamp.toDate) data.paidTimestamp = data.paidTimestamp.toDate().getTime();
                    return { id: doc.id, ...data };
                });
                console.log(`‚úÖ Loaded ${onlineOrdersData.length} online orders`);
                
                // Sample first 5 orders to check address fields
                console.log('üîç Sample Online Orders (first 5):');
                onlineOrdersData.slice(0, 5).forEach((order, idx) => {
                    console.log(`  Order ${idx + 1}:`, {
                        id: order.id,
                        address: order.address || '‚ùå NO ADDRESS',
                        city: order.city || '‚ùå NO CITY',
                        clientName: order.clientName || 'N/A',
                        price: order.price || 0,
                        hasAddress: !!order.address,
                        hasCity: !!order.city
                    });
                });
                
                mergeData();
            });

            // 3. Listen for Store Sales
            onSnapshot(collection(db, 'storeSales'), (snapshot) => {
                console.log(`üè™ Store sales snapshot: ${snapshot.docs.length} documents`);
                storeSalesData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) data.timestamp = data.timestamp.toDate().getTime();
                    return { id: doc.id, ...data };
                });
                console.log(`‚úÖ Loaded ${storeSalesData.length} store sales`);
                
                // Sample first 5 store sales to check address fields
                console.log('üîç Sample Store Sales (first 5):');
                storeSalesData.slice(0, 5).forEach((sale, idx) => {
                    console.log(`  Sale ${idx + 1}:`, {
                        id: sale.id,
                        address: sale.address || '‚ùå NO ADDRESS',
                        city: sale.city || '‚ùå NO CITY',
                        clientName: sale.clientName || 'N/A',
                        price: sale.price || 0,
                        hasAddress: !!sale.address,
                        hasCity: !!sale.city
                    });
                });
                
                mergeData();
            });

            updateDebtorsCreditors();

            // Filter Listeners
            const handleFilterChange = (e) => {
                currentDaysFilter = e.target.value;
                document.getElementById('sidebar-time-filter').value = currentDaysFilter;
                document.getElementById('main-time-filter').value = currentDaysFilter;
                updateAnalytics();
                updateMap();
            };

            document.getElementById('sidebar-time-filter').addEventListener('change', handleFilterChange);
            document.getElementById('main-time-filter').addEventListener('change', handleFilterChange);
        };

        // Wait for authentication before loading data
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("‚úÖ User authenticated:", user.uid);
                startApp();
            } else {
                console.log("üîÑ Signing in anonymously...");
                signInAnonymously(auth).catch(err => console.error("Auth error:", err));
            }
        });
    </script>
</body>
</html>
