<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creditors - Danfosal App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="keyboard-navigation.js"></script>
    <link rel="stylesheet" href="glassmorphism.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 md:p-8 theme-transition">

    <!-- Theme Toggle Removed -->

    <!-- Red Dot Notification -->
    <div class="red-dot" title="New notifications available"></div>

    <div class="max-w-4xl mx-auto relative z-10">
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-red-400">Creditors (I Owe)</h1>
                <p class="theme-text-secondary">List of people or companies you owe money to.</p>
            </div>
            <a href="debts.html" class="glass-btn inline-flex items-center">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                Back to Debts
            </a>
        </header>

        <div class="glass-container mb-8">
            <h3 class="text-xl font-bold mb-4 theme-text">Add New Creditor</h3>
            <div class="flex gap-4">
                <input type="text" id="creditor-name" placeholder="Creditor Name" class="flex-grow bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:ring-2 focus:ring-orange-500 outline-none">
                <button id="add-creditor-btn" class="glass-btn bg-orange-600 hover:bg-orange-700">Add</button>
            </div>
        </div>

        <div id="creditors-list-container" class="space-y-3">
            <p class="theme-text-secondary text-center">Loading creditors...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDUtblUqNiSCmC4kRjikE7D2kba0Mhxej4",
            authDomain: "danfosal-app.firebaseapp.com",
            projectId: "danfosal-app",
            storageBucket: "danfosal-app.appspot.com",
            messagingSenderId: "565855692028",
            appId: "1:565855692028:web:c7cb647497cb3df9452379",
            measurementId: "G-50JPG2KKEC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const startApp = async () => {
            const creditorsRef = collection(db, 'creditors');
            const creditorsListContainer = document.getElementById('creditors-list-container');
            const addCreditorBtn = document.getElementById('add-creditor-btn');

            onSnapshot(query(creditorsRef), async (snapshot) => {
                creditorsListContainer.innerHTML = '<p class="text-gray-500 text-center">Calculating balances...</p>';
                if (snapshot.empty) {
                    creditorsListContainer.innerHTML = '<p class="text-gray-500 text-center">No creditors added yet.</p>';
                    return;
                }

                const creditorPromises = snapshot.docs.map(async (creditorDoc) => {
                    const creditor = { id: creditorDoc.id, ...creditorDoc.data() };
                    
                    const productsRef = collection(db, `creditors/${creditor.id}/products`);
                    const invoicesRef = collection(db, `creditors/${creditor.id}/invoices`);
                    const paymentsRef = collection(db, `creditors/${creditor.id}/payments`);

                    const productsSnap = await getDocs(productsRef);
                    const invoicesSnap = await getDocs(invoicesRef);
                    const paymentsSnap = await getDocs(paymentsRef);

                    // Total debt from products
                    const totalProductDebt = productsSnap.docs.reduce((acc, doc) => acc + doc.data().price, 0);
                    
                    // Total debt from invoices (use remainingBalance)
                    const totalInvoiceDebt = invoicesSnap.docs.reduce((acc, doc) => acc + (doc.data().remainingBalance || 0), 0);
                    
                    const balance = totalProductDebt + totalInvoiceDebt;

                    return { ...creditor, balance };
                });

                const creditorsWithBalances = await Promise.all(creditorPromises);

                creditorsListContainer.innerHTML = '';
                creditorsWithBalances.forEach(creditor => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between glass-card p-4 hover:bg-white/5 transition-colors';
                    div.innerHTML = `
                        <a href="creditor_detail.html?id=${creditor.id}" class="flex-grow">
                            <p class="font-bold text-lg theme-text">${creditor.name}</p>
                            <p class="text-sm theme-text-secondary">Balance: â‚¬${creditor.balance.toFixed(2)}</p>
                        </a>
                        <button data-id="${creditor.id}" class="delete-creditor-btn text-gray-400 hover:text-red-500 transition-colors">Delete</button>
                    `;
                    creditorsListContainer.appendChild(div);
                });
            });

            addCreditorBtn.addEventListener('click', async () => {
                const nameInput = document.getElementById('creditor-name');
                if (nameInput.value.trim()) {
                    await addDoc(creditorsRef, { name: nameInput.value.trim() });
                    nameInput.value = '';
                }
            });
            
            creditorsListContainer.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-creditor-btn');
                if (deleteBtn) {
                    const creditorId = deleteBtn.dataset.id;
                    if (confirm('Are you sure you want to delete this creditor and all their associated data?')) {
                        const batch = writeBatch(db);
                        const productsRef = collection(db, `creditors/${creditorId}/products`);
                        const paymentsRef = collection(db, `creditors/${creditorId}/payments`);
                        const productsSnap = await getDocs(productsRef);
                        const paymentsSnap = await getDocs(paymentsRef);
                        productsSnap.forEach(doc => batch.delete(doc.ref));
                        paymentsSnap.forEach(doc => batch.delete(doc.ref));
                        batch.delete(doc(db, 'creditors', creditorId));
                        await batch.commit();
                    }
                }
            });
        };
        // Wait for authentication before loading data
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("âœ… User authenticated:", user.uid);
                startApp();
            } else {
                console.log("ðŸ”„ Signing in anonymously...");
                signInAnonymously(auth).catch(err => console.error("Auth error:", err));
            }
        });
    </script>
</body>
</html>