<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices - Danfosal App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="glassmorphism.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 md:p-8 theme-transition">

    <!-- Theme Toggle Removed -->

    <!-- Red Dot Notification -->
    <div class="red-dot" title="New notifications available"></div>

    <div class="max-w-4xl mx-auto relative z-10">
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 id="debtor-name-header" class="text-3xl md:text-4xl font-extrabold gradient-text">Invoices for...</h1>
                <p class="theme-text-secondary">Manage all invoices for this debtor.</p>
            </div>
            <a href="debtors_list.html" class="glass-btn inline-flex items-center">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                Back to Debtors
            </a>
        </header>

        <div class="glass-container mb-8">
            <h3 class="text-xl font-bold mb-4 theme-text">Add New Invoice</h3>
            <div class="flex gap-4">
                <input type="text" id="invoice-number" placeholder="Invoice Number" class="flex-grow bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:ring-2 focus:ring-orange-500 outline-none">
                <input type="number" id="invoice-amount" placeholder="Total Amount (â‚¬)" class="w-48 bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:ring-2 focus:ring-orange-500 outline-none">
                <button id="add-invoice-btn" class="glass-btn bg-orange-600 hover:bg-orange-700">Add Invoice</button>
            </div>
        </div>

        <div id="invoices-list-container" class="space-y-3">
            <p class="theme-text-secondary text-center">Loading invoices...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDUtblUqNiSCmC4kRjikE7D2kba0Mhxej4",
            authDomain: "danfosal-app.firebaseapp.com",
            projectId: "danfosal-app",
            storageBucket: "danfosal-app.appspot.com",
            messagingSenderId: "565855692028",
            appId: "1:565855692028:web:c7cb647497cb3df9452379",
            measurementId: "G-50JPG2KKEC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const startApp = async () => {

            const params = new URLSearchParams(window.location.search);
            const debtorId = params.get('debtorId');
            const debtorName = decodeURIComponent(params.get('debtorName'));
            document.getElementById('debtor-name-header').textContent = `Invoices for ${debtorName}`;

            if (!debtorId) {
                document.body.innerHTML = `<h1 class="text-red-500 text-center">Error: No Debtor ID provided.</h1>`;
                return;
            }

            const invoicesRef = collection(db, `debtors/${debtorId}/invoices`);
            const invoicesListContainer = document.getElementById('invoices-list-container');
            const addInvoiceBtn = document.getElementById('add-invoice-btn');

            onSnapshot(query(invoicesRef), (snapshot) => {
                invoicesListContainer.innerHTML = '';
                if (snapshot.empty) {
                    invoicesListContainer.innerHTML = '<p class="text-gray-500 text-center">No invoices found. Add one above!</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const invoice = { id: doc.id, ...doc.data() };
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between glass-card p-4 hover:bg-white/5 transition-colors';
                    div.innerHTML = `
                        <a href="debtor_detail_page.html?debtorId=${debtorId}&invoiceId=${invoice.id}" class="flex-grow">
                            <p class="font-bold text-lg theme-text">${invoice.number}</p>
                            <p class="text-sm theme-text-secondary">Total: â‚¬${invoice.totalAmount.toFixed(2)} | Remaining: â‚¬${invoice.remainingBalance.toFixed(2)}</p>
                        </a>
                        <button data-id="${invoice.id}" class="delete-invoice-btn text-gray-400 hover:text-red-500 transition-colors">Delete</button>
                    `;
                    invoicesListContainer.appendChild(div);
                });
            });

            addInvoiceBtn.addEventListener('click', async () => {
                const number = document.getElementById('invoice-number').value.trim();
                const amount = parseFloat(document.getElementById('invoice-amount').value);
                if (number && !isNaN(amount)) {
                    await addDoc(invoicesRef, {
                        number: number,
                        totalAmount: amount,
                        remainingBalance: amount,
                        items: [],
                        payments: []
                    });
                    document.getElementById('invoice-number').value = '';
                    document.getElementById('invoice-amount').value = '';
                }
            });

            invoicesListContainer.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-invoice-btn')) {
                    const invoiceId = e.target.dataset.id;
                    if (confirm('Are you sure you want to delete this invoice?')) {
                        await deleteDoc(doc(db, `debtors/${debtorId}/invoices`, invoiceId));
                    }
                }
            });
        };
        // Wait for authentication before loading data
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("âœ… User authenticated:", user.uid);
                startApp();
            } else {
                console.log("ðŸ”„ Signing in anonymously...");
                signInAnonymously(auth).catch(err => console.error("Auth error:", err));
            }
        });
    </script>
</body>
</html>