<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Online Sales Management</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&amp;family=Spline+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8b5cf6", // Violet 500
                        "primary-hover": "#7c3aed", // Violet 600
                        "secondary": "#a78bfa", // Violet 400
                        "accent": "#f43f5e", // Rose 500
                        "background-light": "#f8fafc", // Slate 50
                        "background-dark": "#0f172a", // Slate 900
                        "surface-dark": "#1e293b", // Slate 800
                        "surface-darker": "#020617", // Slate 950
                        "text-secondary": "#94a3b8", // Slate 400
                        "border-color": "#334155", // Slate 700
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
        /* Modal Styles */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display h-screen w-full overflow-hidden flex selection:bg-primary selection:text-white">
<div class="w-20 lg:w-64 flex flex-col border-r border-white/5 bg-surface-dark h-full shrink-0 transition-all duration-300 z-30">
<div class="p-4 flex items-center gap-3 h-20">
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 shrink-0 border border-white/10" data-alt="Store logo abstract geometric shape" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDE4NXSlrUoDIbcEiIAikXxBwSfLKB67GYLB897ClgpE-t1S5D89HFFZnpERshoVARtrat4PwkKuyZ4NcFy3dk-Zz0tHS98xceCSg_olqAhQUqb9UBOzg39reLDSzIHT0C22sGaFsQeYXDwpzM52GFGiAcioBIyU4E2lwX1zSqj7JTCQZypnTYr1HExv0vm9tkPqBW4laYJj5wJEk2BdfSb_q_4NGaRDhrffcttMMUsU-5SDxxm0j_W196ZADD6ljrG7rk8u0PCvigI");'></div>
<div class="hidden lg:flex flex-col overflow-hidden">
<h1 class="text-white text-base font-bold leading-normal truncate">Store POS</h1>
<p class="text-slate-400 text-xs font-normal leading-normal">v2.4</p>
</div>
</div>
<nav class="flex flex-col gap-2 p-3 flex-1 overflow-y-auto">
<a class="flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-white/5 transition-colors group" href="store-sales.html">
<span class="material-symbols-outlined text-slate-400 group-hover:text-white">point_of_sale</span>
<p class="hidden lg:block text-slate-400 group-hover:text-white text-sm font-medium">Sales</p>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-xl bg-primary/10 border border-primary/20 group transition-colors" href="online-orders.html">
<span class="material-symbols-outlined text-primary">shopping_cart</span>
<p class="hidden lg:block text-white text-sm font-medium">Online Orders</p>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-white/5 transition-colors group" href="products.html">
<span class="material-symbols-outlined text-slate-400 group-hover:text-white">inventory_2</span>
<p class="hidden lg:block text-slate-400 group-hover:text-white text-sm font-medium">Inventory</p>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-white/5 transition-colors group" href="#">
<span class="material-symbols-outlined text-slate-400 group-hover:text-white">bar_chart</span>
<p class="hidden lg:block text-slate-400 group-hover:text-white text-sm font-medium">Reports</p>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-white/5 transition-colors group" href="customer-portal.html">
<span class="material-symbols-outlined text-slate-400 group-hover:text-white">people</span>
<p class="hidden lg:block text-slate-400 group-hover:text-white text-sm font-medium">Customers</p>
</a>
</nav>
<div class="p-4 border-t border-white/5">
<div class="flex items-center gap-3 px-2 py-2 rounded-lg hover:bg-white/5 cursor-pointer" onclick="window.location.href='settings.html'">
<span class="material-symbols-outlined text-slate-400">settings</span>
<p class="hidden lg:block text-slate-400 text-sm font-medium">Settings</p>
</div>
<div class="flex items-center gap-3 px-2 py-2 mt-2 rounded-lg hover:bg-white/5 cursor-pointer text-red-400 hover:text-red-300" onclick="window.location.href='index.html'">
<span class="material-symbols-outlined">logout</span>
<p class="hidden lg:block text-sm font-medium">Logout</p>
</div>
</div>
</div>
<main class="flex-1 flex flex-col h-full overflow-hidden relative bg-gradient-to-br from-background-dark via-[#020617] to-[#0b0f19]">
<header class="flex justify-between items-start p-6 pb-2 shrink-0 z-20">
<div class="flex flex-col gap-1">
<h2 class="text-white text-3xl font-bold leading-tight tracking-tight">Online Orders Management</h2>
<p class="text-slate-400 text-sm font-normal">Manage, track, and fulfill your web store orders.</p>
</div>
<div class="flex gap-4 items-center">
<div id="active-users-stack" class="flex -space-x-2">
<!-- Avatars injected here -->
</div>
<button class="size-10 flex items-center justify-center rounded-full bg-surface-dark text-white hover:bg-primary hover:text-white transition-all relative">
<span class="material-symbols-outlined">notifications</span>
<span class="absolute top-2 right-2 size-2.5 bg-accent rounded-full border-2 border-background-dark"></span>
</button>
</div>
</header>
<div class="px-6 py-4 shrink-0 flex flex-col lg:flex-row gap-4 items-center justify-between z-20">
<div class="relative w-full lg:w-96 group">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<span class="material-symbols-outlined text-slate-500 group-focus-within:text-primary transition-colors">search</span>
</div>
<input id="order-search" class="block w-full pl-10 pr-3 py-3 border border-border-color rounded-xl leading-5 bg-surface-dark text-white placeholder-slate-500 focus:outline-none focus:bg-slate-800 focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm transition-all shadow-lg" placeholder="Search orders, customers..." type="text"/>
<div class="absolute inset-y-0 right-0 pr-3 flex items-center">
<span class="text-slate-500 text-xs border border-slate-600 rounded px-1.5 py-0.5">‚åòK</span>
</div>
</div>
<div class="flex gap-3 w-full lg:w-auto overflow-x-auto scrollbar-hide">
<div class="relative">
<select id="status-filter" class="bg-surface-dark border border-border-color text-white text-sm rounded-xl focus:ring-primary focus:border-primary block w-full pl-4 pr-10 py-3 cursor-pointer hover:bg-slate-800 transition-colors shadow-lg">
<option value="all">All Statuses</option>
<option value="Ordered">Ordered</option>
<option value="Pending">Pending</option>
<option value="Processing">Processing</option>
<option value="Shipped">Shipped</option>
<option value="Paid">Paid</option>
<option value="Delivered">Delivered</option>
<option value="Returned">Returned</option>
<option value="Cancelled">Cancelled</option>
</select>

</div>
<button onclick="openCreateOrderModal()" class="bg-primary text-white text-sm font-bold rounded-xl px-5 py-3 flex items-center gap-2 hover:bg-primary-hover transition-all shadow-[0_0_15px_rgba(139,92,246,0.3)]">
<span class="material-symbols-outlined text-xl">add</span>
<span>Manual Order</span>
</button>
</div>
</div>
<div class="px-6 pb-2 grid grid-cols-2 md:grid-cols-4 gap-4 shrink-0">
<div class="bg-surface-dark/50 border border-white/5 rounded-xl p-4 flex flex-col gap-1 backdrop-blur-sm">
<span class="text-slate-400 text-xs font-medium uppercase tracking-wider">Pending Orders</span>
<div class="flex items-end justify-between">
<span id="stat-pending" class="text-white text-2xl font-bold font-mono">0</span>
<span class="text-accent text-xs font-bold flex items-center bg-accent/10 px-1.5 py-0.5 rounded">+ New</span>
</div>
</div>
<div class="bg-surface-dark/50 border border-white/5 rounded-xl p-4 flex flex-col gap-1 backdrop-blur-sm">
<span class="text-slate-400 text-xs font-medium uppercase tracking-wider">To Ship</span>
<div class="flex items-end justify-between">
<span id="stat-toship" class="text-white text-2xl font-bold font-mono">0</span>
<span class="text-yellow-400 text-xs font-bold flex items-center bg-yellow-400/10 px-1.5 py-0.5 rounded">Urgent</span>
</div>
</div>
</div>
<div class="flex-1 overflow-y-auto px-6 py-4">
<div id="orders-list" class="flex flex-col gap-3 pb-20">
<div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-slate-500 text-xs font-semibold uppercase tracking-wider">
<div class="col-span-4">Customer</div>
<div class="col-span-2">Date</div>
<div class="col-span-2">Amount</div>
<div class="col-span-2">Status</div>
<div class="col-span-2 text-right">Actions</div>
</div>
<!-- Orders will be injected here -->
<div class="text-center py-10 text-slate-500">Loading orders...</div>
</div>
</div>
</main>
<aside id="order-details-sidebar" class="hidden xl:flex w-[400px] bg-background-dark border-l border-white/5 flex-col shrink-0 h-full shadow-2xl z-20 overflow-y-auto fixed right-0 top-0 xl:relative transition-transform duration-300 transform translate-x-full xl:translate-x-0">
<div class="p-6 border-b border-white/5 bg-surface-dark sticky top-0 z-10">
<div class="flex justify-between items-start mb-4">
<div>
<span id="detail-status-badge" class="px-2 py-1 rounded bg-yellow-500/10 text-yellow-500 text-xs font-bold border border-yellow-500/20">Pending</span>
<h2 id="detail-id" class="text-white text-2xl font-bold mt-2 hidden">Order #...</h2>
</div>
<button onclick="closeSidebar()" class="text-slate-400 hover:text-white transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>
<div class="flex items-center gap-3">
<div id="detail-avatar" class="size-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center font-bold text-sm">SJ</div>
<div>
<p id="detail-name" class="text-white font-medium">Sarah Jenkins</p>
<p id="detail-phone" class="text-slate-400 text-xs">+1 234 567 890</p>
</div>
<button class="ml-auto p-2 hover:bg-white/10 rounded-lg text-slate-400 transition-colors">
<span class="material-symbols-outlined text-lg">chat</span>
</button>
</div>
</div>
<div class="p-6 flex flex-col gap-6">
<div>
<h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3">Items Purchased</h3>
<div id="detail-items" class="flex flex-col gap-3">
<!-- Items injected here -->
</div>
</div>
<div class="bg-surface-dark p-4 rounded-xl border border-white/5">
<h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3">Payment Details</h3>
<div class="flex justify-between text-sm mb-1">
<span class="text-slate-400">Subtotal</span>
<span id="detail-subtotal" class="text-white">‚Ç¨0.00</span>
</div>
<div class="flex justify-between text-sm mb-3">
<span class="text-slate-400">Shipping</span>
<span id="detail-shipping-cost" class="text-white">Free</span>
</div>
<div class="pt-3 border-t border-white/10 flex justify-between items-end">
<span class="text-white font-bold">Total Paid</span>
<span id="detail-total" class="text-primary font-mono text-xl font-bold">‚Ç¨0.00</span>
</div>
</div>
<div>
<h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3">Shipping Address</h3>
<div class="p-4 rounded-xl border border-white/5 bg-surface-dark">
<p id="detail-ship-name" class="text-white text-sm font-medium">Sarah Jenkins</p>
<p id="detail-ship-address" class="text-slate-400 text-sm mt-1">123 Market Street, Apt 4B<br/>San Francisco, CA 94103<br/>United States</p>
</div>
</div>
<div>
<h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3">Activity</h3>
<div id="activity-log-container" class="relative pl-4 border-l border-white/10 space-y-6">
<div class="relative">
<div class="absolute -left-[21px] top-1 size-2.5 rounded-full bg-primary ring-4 ring-background-dark"></div>
<p class="text-white text-sm">Order Placed</p>
<p id="detail-date" class="text-slate-500 text-xs">Oct 24, 10:42 AM</p>
</div>
</div>
</div>
<div class="mt-auto pt-6 flex flex-col gap-3">
<div class="relative">
    <select id="detail-status-select" class="w-full py-3 bg-surface-dark text-white font-bold rounded-xl border border-white/10 hover:border-primary focus:ring-primary focus:border-primary px-4 cursor-pointer">
        <option value="Ordered">Ordered</option>
        <option value="Pending">Pending</option>
        <option value="Processing">Processing</option>
        <option value="Shipped">Shipped</option>
        <option value="Paid">Paid</option>
        <option value="Delivered">Delivered</option>
        <option value="Returned">Returned</option>
        <option value="Cancelled">Cancelled</option>
    </select>

</div>
<button id="print-warranty-btn" class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-hover transition-all shadow-lg shadow-primary/20 flex justify-center items-center gap-2">
<span class="material-symbols-outlined">verified_user</span>
                    Print Warranty
                </button>
</div>
</div>
</aside>

<!-- Warranty Modal -->
<div id="warranty-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-surface-dark border border-white/10 rounded-2xl w-full max-w-lg p-6 shadow-2xl transform transition-all">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">verified_user</span>
                Create Warranty Card
            </h3>
            <button onclick="closeWarrantyModal()" class="text-slate-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Customer Name</label>
                <input type="text" id="warranty-customer-name" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
            
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Select Items</label>
                <div id="warranty-items-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                    <!-- Items injected here -->
                </div>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Serial Numbers (Comma separated)</label>
                <input type="text" id="warranty-serial-numbers" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
        </div>
        
        <div class="mt-8 flex gap-3">
            <button onclick="closeWarrantyModal()" class="flex-1 py-3 bg-surface-dark border border-white/10 text-white font-bold rounded-xl hover:bg-white/5 transition-colors">Cancel</button>
            <button onclick="printUnifiedWarrantyCard()" class="flex-1 py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-hover transition-colors shadow-lg shadow-primary/20">Generate Card</button>
        </div>
    </div>
</div>

<!-- Edit Order Modal -->
<div id="edit-order-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-surface-dark border border-white/10 rounded-2xl w-full max-w-2xl p-6 shadow-2xl transform transition-all">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-orange-500">edit</span>
                Edit Order
            </h3>
            <button onclick="closeEditModal()" class="text-slate-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        
        <input type="hidden" id="edit-order-id">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Client Name</label>
                <input type="text" id="edit-client-name" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Telephone</label>
                <input type="text" id="edit-telephone" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Address</label>
                <input type="text" id="edit-address" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Shipping Fee (‚Ç¨)</label>
            <input type="number" id="edit-shipping-fee" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary" placeholder="0.00">
        </div>
        
        <div class="bg-background-dark p-4 rounded-xl border border-white/5 mb-6">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Order Items</label>
            <div id="edit-order-items" class="space-y-2 mb-4">
                <!-- Items list -->
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center pt-4 border-t border-white/10">
                <div class="md:col-span-2">
                    <input type="text" id="edit-product-select" list="products-datalist" placeholder="Add Product" class="w-full bg-surface-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
                    <datalist id="products-datalist"></datalist>
                </div>
                <input type="number" id="edit-product-quantity" placeholder="Qty" min="1" value="1" class="w-full bg-surface-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
                <button id="add-product-to-edit-btn" class="w-full py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-colors">Add</button>
            </div>
        </div>
        
        <div class="flex justify-end gap-3">
            <button onclick="closeEditModal()" class="px-6 py-3 bg-surface-dark border border-white/10 text-white font-bold rounded-xl hover:bg-white/5 transition-colors">Cancel</button>
            <button id="save-edit-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-500 transition-colors shadow-lg shadow-green-600/20">Save Changes</button>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div id="create-order-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-surface-dark border border-white/10 rounded-2xl w-full max-w-2xl p-6 shadow-2xl transform transition-all">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">add_shopping_cart</span>
                Create Manual Order
            </h3>
            <button onclick="closeCreateOrderModal()" class="text-slate-400 hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Client Name</label>
                <input type="text" id="create-client-name" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Telephone</label>
                <input type="text" id="create-telephone" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Address</label>
                <input type="text" id="create-address" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Shipping Fee (‚Ç¨)</label>
            <input type="number" id="create-shipping-fee" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary" value="0">
        </div>
        
        <div class="bg-background-dark p-4 rounded-xl border border-white/5 mb-6">
            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Order Items</label>
            <div id="create-order-items" class="space-y-2 mb-4">
                <!-- Items list -->
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center pt-4 border-t border-white/10">
                <div class="md:col-span-2">
                    <input type="text" id="create-product-select" list="products-datalist" placeholder="Add Product" class="w-full bg-surface-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
                </div>
                <input type="number" id="create-product-quantity" placeholder="Qty" min="1" value="1" class="w-full bg-surface-dark border border-white/10 rounded-lg px-4 py-2 text-white focus:ring-primary focus:border-primary">
                <button id="add-product-to-create-btn" class="w-full py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-colors">Add</button>
            </div>
        </div>
        
        <div class="flex justify-end gap-3">
            <button onclick="closeCreateOrderModal()" class="px-6 py-3 bg-surface-dark border border-white/10 text-white font-bold rounded-xl hover:bg-white/5 transition-colors">Cancel</button>
            <button id="save-create-btn" class="px-6 py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-hover transition-colors shadow-lg shadow-primary/20">Create Order</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDUtblUqNiSCmC4kRjikE7D2kba0Mhxej4",
        authDomain: "danfosal-app.firebaseapp.com",
        projectId: "danfosal-app",
        storageBucket: "danfosal-app.appspot.com",
        messagingSenderId: "565855692028",
        appId: "1:565855692028:web:c7cb647497cb3df9452379",
        measurementId: "G-50JPG2KKEC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let allOrders = [];
    let masterProductList = [];
    let currentWarrantyOrder = null;
    let editingOrderItems = [];
    let creatingOrderItems = [];

    function formatDate(timestamp) {
        if (!timestamp) return '-';
        try {
            // Handle Firestore Timestamp or standard Date/string
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            // Check if date is valid
            if (isNaN(date.getTime())) return '-';
            
            return date.toLocaleString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        } catch (e) {
            console.error("Date formatting error:", e);
            return '-';
        }
    }

    function init() {
        const ordersRef = collection(db, 'onlineOrders');
        const productsRef = collection(db, 'products');

        // Fetch Products for Datalist
        onSnapshot(productsRef, (snapshot) => {
            masterProductList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const datalist = document.getElementById('products-datalist');
            datalist.innerHTML = masterProductList.map(p => `<option value="${p.name}"></option>`).join('');
        });

        onSnapshot(ordersRef, (snapshot) => {
            allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Sort by Status Priority then Date
            const statusPriority = {
                'Ordered': 1,
                'Pending': 1,
                'Processing': 2,
                'Shipped': 3,
                'Paid': 4,
                'Returned': 5,
                'Delivered': 6,
                'Cancelled': 7
            };

            allOrders.sort((a, b) => {
                const statusA = statusPriority[a.status] || 99;
                const statusB = statusPriority[b.status] || 99;
                if (statusA !== statusB) return statusA - statusB;
                // Sort by date descending (newest first)
                // Handle invalid dates or missing timestamps
                const timeA = a.timestamp || 0;
                const timeB = b.timestamp || 0;
                return timeB - timeA;
            });
            
            applyFiltersAndRender();
            updateStats();
            updateAvatarStack();
            
            // If sidebar is open, update it
            const detailName = document.getElementById('detail-name').textContent;
            if (detailName && detailName !== 'Sarah Jenkins') { // Check if it's not the placeholder
                 // Find currently open order by some unique prop if possible, or just close it if deleted
                 // For simplicity, we won't auto-update sidebar content in real-time if it's complex, 
                 // but we can try to find the order by ID if we stored it.
                 // Let's store ID in a data attribute on the sidebar container
                 const sidebar = document.getElementById('order-details-sidebar');
                 const currentId = sidebar.dataset.currentOrderId;
                 if (currentId) {
                     const current = allOrders.find(o => o.id === currentId);
                     if (current) showOrderDetails(current.id);
                     else closeSidebar();
                 }
            }
        }, (err) => {
            console.error("Error fetching orders:", err);
            document.getElementById('orders-list').innerHTML = `<div class="text-center py-10 text-red-500">Error loading orders</div>`;
        });
    }

    function renderOrders(orders) {
        const container = document.getElementById('orders-list');
        const header = `<div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-slate-500 text-xs font-semibold uppercase tracking-wider">
            <div class="col-span-4">Customer</div>
            <div class="col-span-2">Date</div>
            <div class="col-span-2">Amount</div>
            <div class="col-span-2">Status</div>
            <div class="col-span-2 text-right">Actions</div>
        </div>`;

        if (orders.length === 0) {
            container.innerHTML = header + `<div class="text-center py-10 text-slate-500">No orders found</div>`;
            return;
        }

        const html = orders.map(order => {
            const date = order.timestamp ? (order.timestamp.toDate ? order.timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : new Date(order.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })) : '-';
            const time = order.timestamp ? (order.timestamp.toDate ? order.timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : new Date(order.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })) : '';
            const initials = order.clientName ? order.clientName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
            
            // Instagram Badge
            const isInstagram = order.source === 'Instagram Chatbot';
            const instagramBadge = isInstagram ? 
                `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-sm">INSTA</span>` : '';

            // Status Styles
            let statusClass = "bg-slate-500/10 text-slate-400 border-slate-500/20";
            let statusIcon = "";
            
            if (order.status === 'Pending' || order.status === 'Ordered') {
                statusClass = "bg-yellow-500/10 text-yellow-500 border-yellow-500/20";
                statusIcon = `<span class="size-1.5 rounded-full bg-yellow-500 animate-pulse"></span>`;
            } else if (order.status === 'Processing') {
                statusClass = "bg-blue-500/10 text-blue-400 border-blue-500/20";
                statusIcon = `<span class="material-symbols-outlined text-[14px]">package_2</span>`;
            } else if (order.status === 'Shipped') {
                statusClass = "bg-primary/10 text-primary border-primary/20";
                statusIcon = `<span class="material-symbols-outlined text-[14px]">local_shipping</span>`;
            } else if (order.status === 'Paid') {
                statusClass = "bg-green-500/10 text-green-400 border-green-500/20";
                statusIcon = `<span class="material-symbols-outlined text-[14px]">check_circle</span>`;
            } else if (order.status === 'Returned') {
                statusClass = "bg-red-500/10 text-red-400 border-red-500/20";
                statusIcon = `<span class="material-symbols-outlined text-[14px]">assignment_return</span>`;
            } else if (order.status === 'Cancelled') {
                statusClass = "bg-red-500/10 text-red-400 border-red-500/20";
                statusIcon = `<span class="material-symbols-outlined text-[14px]">cancel</span>`;
            } else if (order.status === 'Delivered') {
                statusClass = "bg-green-500/10 text-green-400 border-green-500/20";
                statusIcon = `<span class="material-symbols-outlined text-[14px]">check_circle</span>`;
            }

            // Avatar Color
            const colors = ['bg-blue-500/20 text-blue-400', 'bg-purple-500/20 text-purple-400', 'bg-pink-500/20 text-pink-400', 'bg-green-500/20 text-green-400'];
            const colorClass = colors[(order.clientName?.length || 0) % colors.length];

            return `
            <div onclick="showOrderDetails('${order.id}')" class="group relative bg-surface-dark border border-transparent hover:border-primary/30 rounded-xl p-4 md:px-4 md:py-3 grid grid-cols-1 md:grid-cols-12 gap-4 items-center transition-all hover:bg-slate-800 shadow-md hover:shadow-lg hover:shadow-primary/5 cursor-pointer">
                <div class="col-span-4 flex items-center gap-3">
                    <div class="size-10 rounded-full ${colorClass} flex items-center justify-center font-bold text-xs shrink-0">${initials}</div>
                    <div class="overflow-hidden">
                        <div class="flex items-center">
                            <p class="text-white font-medium text-sm truncate">${order.clientName || 'Unknown'}</p>
                            ${instagramBadge}
                        </div>
                        <p class="text-slate-400 text-xs truncate">${order.telephone || 'No Phone'}</p>
                        <p class="text-slate-500 text-[10px] truncate">${order.address || 'No Address'}</p>
                    </div>
                </div>
                <div class="col-span-2 flex items-center justify-between md:justify-start">
                    <span class="md:hidden text-slate-400 text-xs font-medium uppercase">Date</span>
                    <div class="flex flex-col">
                        <span class="text-white text-sm">${date}</span>
                        <span class="text-slate-500 text-xs">${time}</span>
                    </div>
                </div>
                <div class="col-span-2 flex items-center justify-between md:justify-start">
                    <span class="md:hidden text-slate-400 text-xs font-medium uppercase">Total</span>
                    <span class="text-white font-mono font-bold">‚Ç¨${(parseFloat(order.price) || 0).toFixed(2)}</span>
                </div>
                <div class="col-span-2 flex items-center justify-between md:justify-start">
                    <span class="md:hidden text-slate-400 text-xs font-medium uppercase">Status</span>
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold ${statusClass} border">
                        ${statusIcon}
                        ${order.status || 'Pending'}
                    </span>
                </div>
                <div class="col-span-2 flex items-center justify-end gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                    <button onclick="openWarrantyModal('${order.id}')" class="p-2 hover:bg-green-500/20 rounded-lg text-green-500 transition-colors" title="Create Warranty">
                        <span class="material-symbols-outlined text-[20px]">verified_user</span>
                    </button>
                    <button onclick="openEditModal('${order.id}')" class="p-2 hover:bg-orange-500/20 rounded-lg text-orange-500 transition-colors" title="Edit Order">
                        <span class="material-symbols-outlined text-[20px]">edit</span>
                    </button>
                    <button onclick="deleteOrder('${order.id}')" class="p-2 hover:bg-red-500/20 rounded-lg text-red-500 transition-colors" title="Delete Order">
                        <span class="material-symbols-outlined text-[20px]">delete</span>
                    </button>
                </div>
            </div>`;
        }).join('');

        container.innerHTML = header + html;
    }

    function updateStats() {
        const pending = allOrders.filter(o => o.status === 'Pending' || o.status === 'Ordered').length;
        const toShip = allOrders.filter(o => o.status === 'Processing' || o.status === 'Pending' || o.status === 'Ordered').length;
        
        document.getElementById('stat-pending').textContent = pending;
        document.getElementById('stat-toship').textContent = toShip;
    }

    function updateAvatarStack() {
        const activeOrders = allOrders.filter(o => o.status === 'Pending' || o.status === 'Processing' || o.status === 'Ordered');
        // Get unique clients
        const uniqueClients = [];
        const seen = new Set();
        for (const order of activeOrders) {
            if (!seen.has(order.clientName)) {
                seen.add(order.clientName);
                uniqueClients.push(order);
            }
            if (uniqueClients.length >= 3) break;
        }

        const stackContainer = document.getElementById('active-users-stack');
        if (uniqueClients.length === 0) {
            stackContainer.innerHTML = '';
            return;
        }

        let html = uniqueClients.map(order => {
            const initials = order.clientName ? order.clientName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
            const colors = ['bg-blue-500', 'bg-purple-500', 'bg-pink-500'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            return `<div class="size-8 rounded-full border-2 border-background-dark ${color} flex items-center justify-center text-xs font-bold text-white" title="${order.clientName}">${initials}</div>`;
        }).join('');

        if (activeOrders.length > 3) {
            html += `<div class="size-8 rounded-full border-2 border-background-dark bg-surface-dark flex items-center justify-center text-xs font-bold text-white">+${activeOrders.length - 3}</div>`;
        }
        
        stackContainer.innerHTML = html;
    }

    window.showOrderDetails = function(id) {
        const order = allOrders.find(o => o.id === id);
        if (!order) return;

        const sidebar = document.getElementById('order-details-sidebar');
        if (!sidebar) return;

        sidebar.dataset.currentOrderId = id;
        sidebar.classList.remove('hidden');
        sidebar.classList.remove('translate-x-full');
        
        const setContent = (id, text) => {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        };

        setContent('detail-id', `Order #${order.id.substring(0,6)}`);
        setContent('detail-status-badge', order.status || 'Pending');
        setContent('detail-name', order.clientName || 'Unknown');
        setContent('detail-phone', order.telephone || 'No Phone');
        setContent('detail-avatar', order.clientName ? order.clientName.substring(0,2).toUpperCase() : '??');
        
        // Items
        const itemsContainer = document.getElementById('detail-items');
        if (itemsContainer) {
            if (order.items && Array.isArray(order.items) && order.items.length > 0) {
                itemsContainer.innerHTML = order.items.map(item => `
                    <div class="flex gap-3">
                        <div class="w-12 h-12 bg-surface-darker rounded-lg shrink-0 border border-white/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-slate-500">inventory_2</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-white text-sm font-medium line-clamp-1">${item.name || 'Item'}</p>
                            <p class="text-slate-500 text-xs">Qty: ${item.quantity || 1} √ó ‚Ç¨${(item.price || 0).toFixed(2)}</p>
                            ${item.serialNumber ? `<p class="text-xs text-primary">SN: ${item.serialNumber}</p>` : ''}
                        </div>
                        <p class="text-white text-sm font-bold">‚Ç¨${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</p>
                    </div>
                `).join('');
            } else {
                itemsContainer.innerHTML = `<p class="text-slate-500 text-sm">No items details available.</p>`;
            }
        }

        // Payment
        const total = parseFloat(order.price) || 0;
        const shipping = parseFloat(order.shippingFee) || 0;
        
        setContent('detail-subtotal', `‚Ç¨${total.toFixed(2)}`);
        // Total Paid = Items only (as requested)
        setContent('detail-total', `‚Ç¨${total.toFixed(2)}`);
        
        // Shipping
        const shippingEl = document.getElementById('detail-shipping-cost');
        if (shippingEl) {
            shippingEl.textContent = shipping > 0 ? `‚Ç¨${shipping.toFixed(2)}` : 'Free';
        }

        // Address
        setContent('detail-ship-name', order.clientName || '');
        setContent('detail-ship-address', order.address || 'No address provided');

        // Date
        setContent('detail-date', formatDate(order.timestamp));

        // Activity Log
        const activityContainer = document.getElementById('activity-log-container');
        if (activityContainer) {
            if (order.activityLog && Array.isArray(order.activityLog) && order.activityLog.length > 0) {
                activityContainer.innerHTML = order.activityLog.map((log, index) => `
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 size-2.5 rounded-full ${index === 0 ? 'bg-primary ring-4 ring-background-dark' : 'bg-slate-600'}"></div>
                        <p class="text-white text-sm">${log.status}</p>
                        <p class="text-slate-500 text-xs">${formatDate(log.timestamp)}</p>
                    </div>
                `).join('');
            } else {
                // Fallback for old orders without log
                activityContainer.innerHTML = `
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 size-2.5 rounded-full bg-primary ring-4 ring-background-dark"></div>
                        <p class="text-white text-sm">Order Placed</p>
                        <p class="text-slate-500 text-xs">${formatDate(order.timestamp)}</p>
                    </div>
                `;
            }
        }

        // Status Select
        const statusSelect = document.getElementById('detail-status-select');
        if (statusSelect) {
            const currentStatus = order.status || 'Pending';
            let matched = false;
            for (let i = 0; i < statusSelect.options.length; i++) {
                if (statusSelect.options[i].value === currentStatus) {
                    statusSelect.selectedIndex = i;
                    matched = true;
                    break;
                }
            }
            if (!matched) {
                console.warn("Status not found in options:", currentStatus);
                statusSelect.value = 'Pending'; 
            }

            const newSelect = statusSelect.cloneNode(true);
            statusSelect.parentNode.replaceChild(newSelect, statusSelect);
            newSelect.onchange = (e) => updateStatus(id, e.target.value);
        }

        const printBtn = document.getElementById('print-warranty-btn');
        if (printBtn) printBtn.onclick = () => openWarrantyModal(id);
    };

    window.closeSidebar = function() {
        const sidebar = document.getElementById('order-details-sidebar');
        sidebar.classList.add('hidden');
        sidebar.dataset.currentOrderId = '';
        setTimeout(() => {
             sidebar.classList.remove('hidden');
             sidebar.classList.add('xl:flex'); 
        }, 100);
    };

    window.updateStatus = async function(orderId, newStatus) {
        console.log(`Attempting to update order ${orderId} to status: ${newStatus}`);
        try {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                console.error("Order not found in local state:", orderId);
                alert("Order not found. Please refresh the page.");
                return;
            }

            // Stock restoration logic if cancelling/returning
            if ((newStatus === 'Cancelled' || newStatus === 'Returned') && order.status !== 'Cancelled' && order.status !== 'Returned') {
                if (confirm(`Are you sure you want to mark this as ${newStatus}? This will restore stock.`)) {
                    await restoreStockForOrder(order);
                } else {
                    // Revert UI
                    const select = document.getElementById('detail-status-select');
                    if (select) select.value = order.status;
                    return;
                }
            }

            const activityEntry = {
                status: newStatus,
                timestamp: new Date()
            };

            // Get current activity log safely
            let currentLog = [];
            if (Array.isArray(order.activityLog) && order.activityLog.length > 0) {
                currentLog = [...order.activityLog];
            } else {
                // If log is empty/missing, preserve the initial creation event
                // Use order.timestamp or fallback to current time if missing
                const creationTime = order.timestamp || new Date();
                // Determine initial status (usually 'Ordered' or 'Pending' if not specified)
                const initialStatus = 'Order Placed'; 
                
                currentLog.push({
                    status: initialStatus,
                    timestamp: creationTime
                });
            }

            // Prepend new activity
            currentLog.unshift(activityEntry);

            // Optimistic Update: Update local state immediately
            const localOrderIndex = allOrders.findIndex(o => o.id === orderId);
            if (localOrderIndex !== -1) {
                allOrders[localOrderIndex].status = newStatus;
                allOrders[localOrderIndex].activityLog = currentLog;
                
                // Re-render UI components
                applyFiltersAndRender();
                updateStats();
                
                // If sidebar is open for this order, update it too
                const sidebar = document.getElementById('order-details-sidebar');
                if (sidebar && sidebar.dataset.currentOrderId === orderId && !sidebar.classList.contains('hidden')) {
                    showOrderDetails(orderId);
                }
            }

            await updateDoc(doc(db, 'onlineOrders', orderId), { 
                status: newStatus,
                activityLog: currentLog
            });
            console.log("Status update successful");
            
        } catch (error) {
            console.error("Error updating status:", error);
            alert(`Failed to update status: ${error.message}`);
            
            // Revert UI
            const order = allOrders.find(o => o.id === orderId);
            if (order) {
                const select = document.getElementById('detail-status-select');
                if (select) select.value = order.status;
            }
        }
    };

    async function restoreStockForOrder(order) {
        if (!order.items || order.items.length === 0) {
            console.log('‚ö†Ô∏è No items to restore for order:', order.id);
            return;
        }
        
        console.log('üîÑ RESTORING STOCK FOR ORDER:', order.id);
        
        for (const item of order.items) {
            let productRef = null;
            
            // Try to find product by ID first (web app orders)
            if (item.id) {
                productRef = doc(db, 'products', item.id);
                console.log(`  Using product ID: ${item.id} for ${item.name}`);
            } else {
                // For Instagram orders without ID, match by producer and name
                const productName = item.name;
                const producer = item.producer || '';
                const product = masterProductList.find(p => 
                    p.name === productName && (p.producer === producer || !producer)
                );
                if (product) {
                    productRef = doc(db, 'products', product.id);
                    console.log(`  Matched by name+producer: ${productName} (${producer}) -> ID: ${product.id}`);
                } else {
                    console.warn(`  ‚ùå Could not find product: ${productName} by ${producer}`);
                }
            }
            
            if (productRef) {
                try {
                    const productDoc = await getDoc(productRef);
                    if (productDoc.exists()) {
                        const currentStock = parseInt(productDoc.data().stock || 0);
                        const newStock = currentStock + parseInt(item.quantity || 0);
                        await updateDoc(productRef, {
                            stock: newStock
                        });
                        console.log(`  ‚úÖ Restored ${item.quantity} units of ${item.name} (${currentStock} ‚Üí ${newStock})`);
                    }
                } catch (err) {
                    console.error("Error restoring stock for item:", item.name, err);
                }
            }
        }
        console.log('‚úÖ STOCK RESTORATION COMPLETE');
    }

    window.deleteOrder = async function(orderId) {
        if (confirm("Are you sure you want to delete this order? This cannot be undone.")) {
            try {
                await deleteDoc(doc(db, 'onlineOrders', orderId));
                closeSidebar();
            } catch (error) {
                console.error("Error deleting order:", error);
                alert("Failed to delete order");
            }
        }
    };

    // --- Warranty Logic ---
    window.openWarrantyModal = function(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;
        currentWarrantyOrder = order;

        document.getElementById('warranty-customer-name').value = order.clientName || '';
        
        const itemsList = document.getElementById('warranty-items-list');
        itemsList.innerHTML = (order.items || []).map((item, index) => `
            <label class="flex items-center gap-3 p-3 bg-background-dark rounded-lg border border-white/5 cursor-pointer hover:bg-white/5 transition-colors">
                <input type="checkbox" id="warranty-item-${index}" value="${index}" checked class="rounded border-white/20 bg-surface-dark text-primary focus:ring-primary">
                <div class="flex-1">
                    <span class="block text-sm font-bold text-white">${item.name} √ó ${item.quantity}</span>
                    <span class="block text-xs text-slate-400">${item.serialNumber ? `SN: ${item.serialNumber}` : 'No SN'}</span>
                </div>
            </label>
        `).join('');

        const serials = (order.items || []).filter(i => i.serialNumber).map(i => i.serialNumber).join(', ');
        document.getElementById('warranty-serial-numbers').value = serials;

        document.getElementById('warranty-modal').classList.remove('hidden');
        document.getElementById('warranty-modal').classList.add('flex');
    };

    window.closeWarrantyModal = function() {
        document.getElementById('warranty-modal').classList.add('hidden');
        document.getElementById('warranty-modal').classList.remove('flex');
        currentWarrantyOrder = null;
    };

    window.printUnifiedWarrantyCard = function() {
        if (!currentWarrantyOrder) return;
        
        const selectedItems = [];
        (currentWarrantyOrder.items || []).forEach((item, index) => {
            const checkbox = document.getElementById(`warranty-item-${index}`);
            if (checkbox && checkbox.checked) {
                selectedItems.push(`${item.producer || ''} ${item.name}`.trim());
            }
        });

        if (selectedItems.length === 0) {
            alert('Please select at least one item.');
            return;
        }

        const customerName = document.getElementById('warranty-customer-name').value;
        const serialNumbers = document.getElementById('warranty-serial-numbers').value;
        let city = 'Vlore';
        if (currentWarrantyOrder.address) {
            const parts = currentWarrantyOrder.address.split(',');
            city = parts[parts.length - 1].trim();
        }
        const currentDate = new Date().toLocaleDateString('en-GB');
        const productNames = selectedItems.join(', ');

        const url = `warranty-card.html?product=${encodeURIComponent(productNames)}&catalog=&serial=${encodeURIComponent(serialNumbers)}&buyer=${encodeURIComponent(customerName)}&date=${currentDate}&location=${encodeURIComponent(city)}`;
        window.open(url, '_blank');
        closeWarrantyModal();
    };

    // --- Edit Logic ---
    window.openEditModal = function(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;
        
        document.getElementById('edit-order-id').value = orderId;
        document.getElementById('edit-client-name').value = order.clientName || '';
        document.getElementById('edit-telephone').value = order.telephone || '';
        document.getElementById('edit-address').value = order.address || '';
        document.getElementById('edit-shipping-fee').value = order.shippingFee || 0;
        
        editingOrderItems = JSON.parse(JSON.stringify(order.items || []));
        renderEditItems();
        
        document.getElementById('edit-order-modal').classList.remove('hidden');
        document.getElementById('edit-order-modal').classList.add('flex');
    };

    window.closeEditModal = function() {
        document.getElementById('edit-order-modal').classList.add('hidden');
        document.getElementById('edit-order-modal').classList.remove('flex');
    };

    function renderEditItems() {
        const container = document.getElementById('edit-order-items');
        container.innerHTML = editingOrderItems.map((item, index) => `
            <div class="flex justify-between items-center bg-surface-dark p-2 rounded border border-white/10">
                <span class="text-sm text-white">${item.name} (x${item.quantity})</span>
                <button onclick="removeEditItem(${index})" class="text-red-400 hover:text-red-300">
                    <span class="material-symbols-outlined text-sm">delete</span>
                </button>
            </div>
        `).join('');
    }

    window.removeEditItem = function(index) {
        editingOrderItems.splice(index, 1);
        renderEditItems();
    };

    document.getElementById('add-product-to-edit-btn').onclick = function() {
        const name = document.getElementById('edit-product-select').value;
        const qty = parseInt(document.getElementById('edit-product-quantity').value) || 1;
        if (!name) return;
        
        // Find price from master list
        const product = masterProductList.find(p => p.name === name);
        const price = product ? parseFloat(product.price) : 0;
        
        editingOrderItems.push({
            name: name,
            quantity: qty,
            price: price,
            id: product ? product.id : null
        });
        
        document.getElementById('edit-product-select').value = '';
        renderEditItems();
    };

    document.getElementById('save-edit-btn').onclick = async function() {
        const orderId = document.getElementById('edit-order-id').value;
        const clientName = document.getElementById('edit-client-name').value;
        const telephone = document.getElementById('edit-telephone').value;
        const address = document.getElementById('edit-address').value;
        const shippingFee = parseFloat(document.getElementById('edit-shipping-fee').value) || 0;
        
        const itemsTotal = editingOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        // Price is just items total, shipping is separate
        const totalPrice = itemsTotal;
        
        try {
            await updateDoc(doc(db, 'onlineOrders', orderId), {
                clientName,
                telephone,
                address,
                items: editingOrderItems,
                shippingFee: shippingFee,
                price: totalPrice
            });
            closeEditModal();
        } catch (error) {
            console.error("Error updating order:", error);
            alert("Failed to update order");
        }
    };

    // --- Create Order Logic ---
    window.openCreateOrderModal = function() {
        document.getElementById('create-client-name').value = '';
        document.getElementById('create-telephone').value = '';
        document.getElementById('create-address').value = '';
        document.getElementById('create-shipping-fee').value = '0';
        creatingOrderItems = [];
        renderCreateItems();
        
        document.getElementById('create-order-modal').classList.remove('hidden');
        document.getElementById('create-order-modal').classList.add('flex');
    };

    window.closeCreateOrderModal = function() {
        document.getElementById('create-order-modal').classList.add('hidden');
        document.getElementById('create-order-modal').classList.remove('flex');
    };

    function renderCreateItems() {
        const container = document.getElementById('create-order-items');
        container.innerHTML = creatingOrderItems.map((item, index) => `
            <div class="flex justify-between items-center bg-surface-dark p-2 rounded border border-white/10">
                <span class="text-sm text-white">${item.name} (x${item.quantity})</span>
                <button onclick="removeCreateItem(${index})" class="text-red-400 hover:text-red-300">
                    <span class="material-symbols-outlined text-sm">delete</span>
                </button>
            </div>
        `).join('');
    }

    window.removeCreateItem = function(index) {
        creatingOrderItems.splice(index, 1);
        renderCreateItems();
    };

    document.getElementById('add-product-to-create-btn').onclick = function() {
        const name = document.getElementById('create-product-select').value;
        const qty = parseInt(document.getElementById('create-product-quantity').value) || 1;
        if (!name) return;
        
        const product = masterProductList.find(p => p.name === name);
        const price = product ? parseFloat(product.price) : 0;
        
        creatingOrderItems.push({
            name: name,
            quantity: qty,
            price: price,
            id: product ? product.id : null
        });
        
        document.getElementById('create-product-select').value = '';
        renderCreateItems();
    };

    document.getElementById('save-create-btn').onclick = async function() {
        const clientName = document.getElementById('create-client-name').value;
        const telephone = document.getElementById('create-telephone').value;
        const address = document.getElementById('create-address').value;
        const shippingFee = parseFloat(document.getElementById('create-shipping-fee').value) || 0;
        
        if (creatingOrderItems.length === 0) {
            alert("Please add at least one item.");
            return;
        }

        const itemsTotal = creatingOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        // Price is just items total, shipping is separate
        const totalPrice = itemsTotal;
        
        try {
            const timestamp = new Date();
            await addDoc(collection(db, 'onlineOrders'), {
                clientName,
                telephone,
                address,
                items: creatingOrderItems,
                shippingFee: shippingFee,
                price: totalPrice,
                status: 'Ordered',
                timestamp: timestamp,
                activityLog: [{
                    status: 'Ordered',
                    timestamp: timestamp
                }]
            });
            closeCreateOrderModal();
        } catch (error) {
            console.error("Error creating order:", error);
            alert("Failed to create order");
        }
    };

    // Search & Filter
    function applyFiltersAndRender() {
        const searchTerm = document.getElementById('order-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        
        let filtered = allOrders;
        
        if (statusFilter !== 'all') {
            filtered = filtered.filter(o => o.status === statusFilter);
        }
        
        if (searchTerm) {
            filtered = filtered.filter(o => 
                (o.clientName && o.clientName.toLowerCase().includes(searchTerm)) ||
                (o.telephone && o.telephone.toLowerCase().includes(searchTerm)) ||
                (o.address && o.address.toLowerCase().includes(searchTerm))
            );
        }
        
        renderOrders(filtered);
    }

    document.getElementById('order-search').addEventListener('input', applyFiltersAndRender);
    document.getElementById('status-filter').addEventListener('change', applyFiltersAndRender);

    init();
</script>
</body>
</html>