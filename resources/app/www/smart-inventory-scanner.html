<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Smart Inventory Scanner - Danfosal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="glassmorphism.css">
    <!-- PDF.js for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Tesseract.js OCR Library -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    
    <!-- Header -->
    <div class="bg-gray-900 border-b border-gray-800 text-white p-6 shadow-2xl">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='products.html'" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg transition-all border border-gray-700">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Products
                </button>
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <i class="fas fa-boxes"></i>
                        Smart Inventory Scanner
                    </h1>
                    <p class="text-gray-400 mt-1">Scan supplier invoices ‚Üí Auto-update stock & costs</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-6">
        
        <!-- Step 1: Upload Invoice -->
        <div id="uploadSection" class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-8 mb-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">1</div>
                <h2 class="text-2xl font-bold text-white">Upload Supplier Invoice</h2>
            </div>
            
            <div class="border-4 border-dashed border-gray-600 rounded-xl p-12 mb-6 hover:border-blue-500 transition-all cursor-pointer text-center bg-gray-900/50" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt text-6xl text-blue-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-white mb-2">Upload Invoice Image or PDF</h3>
                <p class="text-gray-300 mb-4 text-lg">Click to select your supplier invoice (K√§rcher, etc.)</p>
                                            <p class="text-sm text-gray-400">Supports: JPG, PNG, PDF (all pages)</p>
            </div>
            
            <input 
                type="file" 
                id="fileInput" 
                accept="image/*,.pdf" 
                class="hidden"
                onchange="handleFileSelect(event)"
            >
            
            <div class="flex gap-4 justify-center">
                <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                    <i class="fas fa-file-upload mr-2"></i>
                    Choose File
                </button>
                
                <button onclick="openCamera()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                    <i class="fas fa-camera mr-2"></i>
                    Take Photo
                </button>
            </div>
        </div>

        <!-- Camera Section -->
        <div id="cameraSection" class="hidden bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-8 mb-6">
            <div class="text-center mb-4">
                <h3 class="text-2xl font-bold text-white mb-2">Position Invoice in Frame</h3>
                <p class="text-gray-300 text-lg">Make sure product codes and prices are visible</p>
            </div>
            
            <div class="relative">
                <video id="cameraPreview" autoplay playsinline class="w-full rounded-lg shadow-lg"></video>
                <canvas id="captureCanvas" class="hidden"></canvas>
            </div>
            
            <div class="flex gap-4 justify-center mt-6">
                <button onclick="capturePhoto()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                    <i class="fas fa-camera mr-2"></i>
                    Capture
                </button>
                <button onclick="closeCamera()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </button>
            </div>
        </div>

        <!-- Processing Section -->
        <div id="processingSection" class="hidden bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-8 mb-6">
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-6xl text-blue-500 mb-6"></i>
                <h3 class="text-2xl font-bold text-white mb-2">Scanning Invoice...</h3>
                <p class="text-gray-300 mb-4 text-lg" id="processingStatus">Initializing OCR engine...</p>
                <div class="w-full bg-gray-700 rounded-full h-4 max-w-md mx-auto">
                    <div id="processingProgress" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Step 2: Review & Confirm -->
        <div id="reviewSection" class="hidden">
            <!-- Invoice Info Card -->
            <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 mb-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">2</div>
                    <h2 class="text-2xl font-bold text-white">Review Extracted Data</h2>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Supplier</label>
                        <input type="text" id="supplierName" class="w-full px-3 py-2 border border-gray-600 bg-gray-800 text-white rounded-lg" />
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Invoice Number</label>
                        <input type="text" id="invoiceNumber" class="w-full px-3 py-2 border border-gray-600 bg-gray-800 text-white rounded-lg" readonly />
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Date</label>
                        <input type="text" id="invoiceDate" class="w-full px-3 py-2 border border-gray-600 bg-gray-800 text-white rounded-lg" readonly />
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <div class="bg-blue-900/30 border border-blue-700 p-4 rounded-lg flex-1">
                        <div class="text-2xl font-bold text-blue-400" id="totalItems">0</div>
                        <div class="text-sm text-gray-300">Total Items</div>
                    </div>
                    <div class="bg-green-900/30 border border-green-700 p-4 rounded-lg flex-1">
                        <div class="text-2xl font-bold text-green-400" id="matchedItems">0</div>
                        <div class="text-sm text-gray-300">Matched Products</div>
                    </div>
                    <div class="bg-orange-900/30 border border-orange-700 p-4 rounded-lg flex-1">
                        <div class="text-2xl font-bold text-orange-400" id="newItems">0</div>
                        <div class="text-sm text-gray-300">New Products</div>
                    </div>
                </div>
            </div>

            <!-- Items Table -->
            <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 mb-6">
                <h3 class="text-xl font-bold text-white mb-4">üì¶ Products Extracted</h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-900 border-b-2 border-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Status</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Code</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Product Name</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Qty</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Unit Cost</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Cost+VAT</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Selling Price</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300">Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 justify-end">
                <button onclick="cancelScan()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </button>
                <button onclick="saveToInventory()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                    <i class="fas fa-save mr-2"></i>
                    Confirm & Save to Inventory
                </button>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div id="resultsSection" class="hidden bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-8">
            <div class="text-center">
                <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
                <h2 class="text-3xl font-bold text-white mb-4">‚úÖ Inventory Updated!</h2>
                
                <div class="grid grid-cols-2 gap-6 max-w-md mx-auto mb-8">
                    <div class="bg-green-900/30 border border-green-700 p-6 rounded-lg">
                        <div class="text-3xl font-bold text-green-400" id="updatedCount">0</div>
                        <div class="text-sm text-gray-300">Products Updated</div>
                    </div>
                    <div class="bg-blue-900/30 border border-blue-700 p-6 rounded-lg">
                        <div class="text-3xl font-bold text-blue-400" id="addedCount">0</div>
                        <div class="text-sm text-gray-300">Products Added</div>
                    </div>
                </div>
                
                <div class="flex gap-4 justify-center">
                    <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                        <i class="fas fa-redo mr-2"></i>
                        Scan Another Invoice
                    </button>
                    <button id="viewInvoiceBtn" onclick="viewInvoiceDetails()" class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>
                        View Invoice Details
                    </button>
                    <button onclick="window.location.href='products.html'" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                        <i class="fas fa-redo mr-2"></i>
                        Scan Another Invoice
                    </button>
                    <button id="viewInvoiceBtn" onclick="viewInvoiceDetails()" class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all hidden">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>
                        View Invoice Details
                    </button>
                    <button onclick="window.location.href='products.html'" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all">
                        <i class="fas fa-boxes mr-2"></i>
                        View Inventory
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Load Smart Inventory Scanner FIRST -->
    <script src="keyboard-navigation.js"></script>
    <script src="smart-inventory-scanner.js"></script>
    <script src="payment-reminder-service.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDUtblUqNiSCmC4kRjikE7D2kba0Mhxej4",
            authDomain: "danfosal-app.firebaseapp.com",
            projectId: "danfosal-app",
            storageBucket: "danfosal-app.appspot.com",
            messagingSenderId: "565855692028",
            appId: "1:565855692028:web:c7cb647497cb3df9452379",
            measurementId: "G-50JPG2KKEC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Wait for authentication before initializing scanner
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("‚úÖ User authenticated:", user.uid);
                await initializeScanner();
            } else {
                console.log("üîÑ Signing in anonymously...");
                signInAnonymously(auth).catch(err => console.error("Auth error:", err));
            }
        });
        
        async function initializeScanner() {
        // Diagnostic checks
        console.log('üîç Diagnostic checks:');
        console.log('  - Tesseract loaded:', typeof Tesseract !== 'undefined');
        console.log('  - SmartInventoryScanner loaded:', typeof SmartInventoryScanner !== 'undefined');
        console.log('  - Firebase initialized:', !!db);

        // Check if SmartInventoryScanner is loaded
        if (typeof SmartInventoryScanner === 'undefined') {
            alert('Scanner not loaded properly. Please refresh the page.');
            throw new Error('SmartInventoryScanner class not found');
        }
        
        // Check if Tesseract is loaded
        if (typeof Tesseract === 'undefined') {
            alert('OCR library (Tesseract) not loaded. Please check your internet connection and refresh.');
            throw new Error('Tesseract library not found');
        }

        // Initialize Smart Inventory Scanner
        console.log('üöÄ Initializing scanner...');
        const scanner = new SmartInventoryScanner(db, {
            collection, addDoc, updateDoc, getDocs, doc, getDoc, query, where
        });
        console.log('‚úÖ Scanner instance created');

        // Initialize Payment Reminder Service
        const reminderService = new PaymentReminderService();
        await reminderService.initialize(db);
        console.log('üîî Reminder service started');

        // Check for AI-pending supplier invoice scan
        checkForAIPendingScan();

        let currentStream = null;
        let scannedData = null;
        let savedCreditorId = null;  // Store creditor ID after saving

        // === PDF TO IMAGE CONVERSION ===
        
        async function convertPdfToImage(file) {
            console.log('üìÑ Converting PDF to images...');
            
            // Set PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            try {
                // Read file as ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();
                
                // Load PDF
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                console.log(`  PDF loaded: ${pdf.numPages} pages`);
                
                const images = [];
                
                // Convert ALL pages to images
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    console.log(`  Converting page ${pageNum}/${pdf.numPages}...`);
                    document.getElementById('processingStatus').textContent = `Converting PDF page ${pageNum}/${pdf.numPages}...`;
                    
                    const page = await pdf.getPage(pageNum);
                    
                    // Set up canvas
                    const viewport = page.getViewport({ scale: 2.0 }); // Higher scale = better quality
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    // Render PDF page to canvas
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    }).promise;
                    
                    // Convert canvas to blob
                    const blob = await new Promise((resolve) => {
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/png');
                    });
                    
                    images.push(blob);
                }
                
                console.log(`  ‚úÖ Converted ${images.length} pages to images`);
                return images; // Return array of image blobs
                
            } catch (error) {
                console.error('PDF conversion error:', error);
                throw new Error('Failed to convert PDF to image: ' + error.message);
            }
        }

        // === AI AUTO-DETECTION ===
        
        function checkForAIPendingScan() {
            try {
                const pendingImage = localStorage.getItem('ai_pending_invoice_scan');
                const scanType = localStorage.getItem('ai_pending_scan_type');
                
                if (pendingImage && scanType === 'supplier') {
                    console.log('ü§ñ AI sent us a supplier invoice to scan');
                    
                    // Clear the stored data
                    localStorage.removeItem('ai_pending_invoice_scan');
                    localStorage.removeItem('ai_pending_scan_type');
                    
                    // Show notification and start scanning process
                    showAIScanNotification();
                    
                    // Process the AI-sent image
                    setTimeout(() => {
                        processAIPendingImage(pendingImage);
                    }, 1000);
                }
            } catch (error) {
                console.log('No AI pending scan or error:', error);
            }
        }

        function showAIScanNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: 600;
                box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
                z-index: 10000;
                animation: slideInRight 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                ü§ñ <strong>AI Assistant:</strong> Processing your supplier invoice!<br>
                <small>Automatically scanning in a moment...</small>
            `;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        async function processAIPendingImage(imageDataURL) {
            try {
                console.log('üì∏ Processing AI-sent supplier invoice...');
                
                // Convert data URL to blob
                const response = await fetch(imageDataURL);
                const blob = await response.blob();
                
                // Create a file-like object
                const file = new File([blob], 'ai-supplier-invoice.png', { type: blob.type });
                
                // Create a fake file input event to trigger existing handler
                const fileInput = document.getElementById('fileInput');
                
                // Create a custom event that mimics file selection
                const mockEvent = {
                    target: {
                        files: [file]
                    }
                };
                
                // Use the existing file handler - let the proven scanner do its job!
                console.log('üöÄ Triggering existing file handler with AI image...');
                await handleFileSelect(mockEvent);
                
            } catch (error) {
                console.error('‚ùå Error processing AI image:', error);
                alert('Error processing AI invoice: ' + error.message);
                showUploadSection();
            }
        }

        // === FILE UPLOAD ===
        
        window.handleFileSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üìÅ File selected:', file.name, file.type, file.size);
            
            showProcessing();
            
            try {
                console.log('üîÑ Starting scan...');
                
                let imagesToScan = [file];
                
                // If PDF, convert ALL pages to images
                if (file.type === 'application/pdf') {
                    document.getElementById('processingStatus').textContent = 'Converting PDF pages to images...';
                    imagesToScan = await convertPdfToImage(file);
                    console.log('  Converted to', imagesToScan.length, 'image blobs');
                }
                
                document.getElementById('processingStatus').textContent = `Scanning ${imagesToScan.length} page(s)...`;
                const result = await scanner.scanSupplierInvoice(imagesToScan);
                
                console.log('üìä Scan result:', result);
                
                if (result.success) {
                    scannedData = result.data;
                    showReviewSection();
                } else {
                    const errorMsg = result.error || 'Unknown error occurred';
                    console.error('‚ùå Scan failed:', errorMsg);
                    alert('Failed to scan invoice: ' + errorMsg + '\n\nCheck browser console (F12) for details.');
                    showUploadSection();
                }
            } catch (error) {
                console.error('üí• Exception during scan:', error);
                console.error('Error stack:', error.stack);
                const errorMsg = error?.message || error?.toString() || 'Unknown error';
                alert('Error scanning invoice: ' + errorMsg + '\n\nCheck browser console (F12) for details.');
                showUploadSection();
            }
        };

        // === CAMERA ===
        
        window.openCamera = async function() {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                document.getElementById('cameraPreview').srcObject = currentStream;
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('cameraSection').classList.remove('hidden');
            } catch (error) {
                alert('Could not access camera: ' + error.message);
            }
        };

        window.closeCamera = function() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
        };

        window.capturePhoto = function() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('captureCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(async (blob) => {
                closeCamera();
                showProcessing();
                
                try {
                    const result = await scanner.scanSupplierInvoice(blob);
                    
                    if (result.success) {
                        scannedData = result.data;
                        showReviewSection();
                    } else {
                        alert('Failed to scan invoice: ' + result.error);
                        showUploadSection();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error scanning invoice: ' + error.message);
                    showUploadSection();
                }
            });
        };

        // === UI SECTIONS ===
        
        function showProcessing() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('cameraSection').classList.add('hidden');
            document.getElementById('reviewSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('processingSection').classList.remove('hidden');
            
            // Simulate progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                document.getElementById('processingProgress').style.width = progress + '%';
                
                if (progress === 30) {
                    document.getElementById('processingStatus').textContent = 'Reading text from image...';
                } else if (progress === 60) {
                    document.getElementById('processingStatus').textContent = 'Extracting product codes...';
                } else if (progress === 90) {
                    document.getElementById('processingStatus').textContent = 'Matching with inventory...';
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 200);
        }

        function showReviewSection() {
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('reviewSection').classList.remove('hidden');
            
            // Populate invoice info
            document.getElementById('supplierName').value = scannedData.supplier || '';
            document.getElementById('invoiceNumber').value = scannedData.invoiceNumber || '';
            document.getElementById('invoiceDate').value = scannedData.date || '';
            
            // Populate stats
            document.getElementById('totalItems').textContent = scannedData.stats.total;
            document.getElementById('matchedItems').textContent = scannedData.stats.matched;
            document.getElementById('newItems').textContent = scannedData.stats.new;
            
            // Populate items table
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            
            scannedData.items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const statusBadge = item.matched ? 
                    '<span class="bg-green-900/40 text-green-300 border border-green-700 px-2 py-1 rounded text-xs font-semibold">‚úì Matched</span>' :
                    '<span class="bg-blue-900/40 text-blue-300 border border-blue-700 px-2 py-1 rounded text-xs font-semibold">+ New</span>';
                
                const actionText = item.matched ? 
                    `Update stock: ${item.existingProduct.stock || 0} ‚Üí ${(item.existingProduct.stock || 0) + item.quantity}` :
                    'Add to inventory';
                
                row.innerHTML = `
                    <td class="p-3">${statusBadge}</td>
                    <td class="p-3 font-mono text-sm">${item.code}</td>
                    <td class="p-3">${item.name}</td>
                    <td class="p-3 font-bold">${item.quantity}</td>
                    <td class="p-3">‚Ç¨${item.unitPrice.toFixed(2)}</td>
                    <td class="p-3 text-orange-600">‚Ç¨${(item.costWithVAT || item.unitPrice * 1.2).toFixed(2)}</td>
                    <td class="p-3 text-green-600 font-bold">‚Ç¨${(item.matched ? item.existingProduct.price : item.suggestedPrice).toFixed(2)}</td>
                    <td class="p-3 text-sm text-gray-600">${actionText}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showUploadSection() {
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('reviewSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
        }

        window.cancelScan = function() {
            if (confirm('Cancel this scan? All data will be lost.')) {
                scannedData = null;
                showUploadSection();
            }
        };

        window.saveToInventory = async function() {
            if (!scannedData || !scannedData.items.length) {
                alert('No items to save');
                return;
            }
            
            const supplier = document.getElementById('supplierName').value.trim();
            if (!supplier) {
                alert('Please enter supplier name');
                return;
            }
            
            if (!confirm(`Save ${scannedData.items.length} products to inventory?`)) {
                return;
            }
            
            showProcessing();
            document.getElementById('processingStatus').textContent = 'Updating inventory...';
            document.getElementById('processingProgress').style.width = '50%';
            
            try {
                // Prepare invoice data
                const invoiceData = {
                    supplier: supplier,
                    invoiceNumber: scannedData.invoiceNumber || 'N/A',
                    totalAmount: scannedData.totalAmount || 0,
                    date: scannedData.date || new Date().toISOString().split('T')[0]
                };
                
                console.log('üéØ HTML: About to call confirmAndSaveToInventory with invoice data:', invoiceData);
                console.log('üéØ HTML: scannedData object:', {
                    hasInvoiceNumber: !!scannedData.invoiceNumber,
                    invoiceNumberValue: scannedData.invoiceNumber,
                    hasTotalAmount: !!scannedData.totalAmount,
                    totalAmountValue: scannedData.totalAmount,
                    hasDate: !!scannedData.date,
                    dateValue: scannedData.date
                });
                
                const results = await scanner.confirmAndSaveToInventory(scannedData.items, invoiceData);
                
                document.getElementById('processingProgress').style.width = '100%';
                
                // Store creditor ID if invoice was saved
                if (results.creditorId) {
                    savedCreditorId = results.creditorId;
                    console.log('üíæ Stored creditor ID:', savedCreditorId);
                }
                
                // Show results
                document.getElementById('processingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('updatedCount').textContent = results.updated;
                document.getElementById('addedCount').textContent = results.added;
                
                // Show "View Invoice" button if we have a creditor ID
                if (savedCreditorId) {
                    document.getElementById('viewInvoiceBtn').classList.remove('hidden');
                }
                
                if (results.errors.length > 0) {
                    console.warn('Some items had errors:', results.errors);
                }
                
            } catch (error) {
                console.error('Error saving:', error);
                alert('Error saving to inventory: ' + error.message);
                showReviewSection();
            }
        };

        window.viewInvoiceDetails = function() {
            if (savedCreditorId) {
                window.location.href = `creditor_detail.html?id=${savedCreditorId}`;
            } else {
                alert('Invoice details not available');
            }
        };
        
        } // End of initializeScanner function

    </script>
</body>
</html>
